import { Checkbox, CircularProgress } from '@material-ui/core';
import { Dialog, Fade, Menu, MenuItem } from '@material-ui/core/index';
import ChevronRightIcon from '@material-ui/icons/ChevronRight';
import DeleteIcon from '@material-ui/icons/Delete';
import DragIndicatorIcon from '@material-ui/icons/DragIndicator';
import ExpandMoreIcon from '@material-ui/icons/ExpandMore';
import MoreVertIcon from '@material-ui/icons/MoreVert';
import TreeItem from '@material-ui/lab/TreeItem';
import TreeView from '@material-ui/lab/TreeView';
import BlurCircularIcon from '@mui/icons-material/BlurCircular';
import Tooltip from '@mui/material/Tooltip';
import classNames from 'classnames';
import _ from 'lodash';
import React, { useEffect, useRef, useState } from 'react';
import ReactHoverObserver from 'react-hover-observer';
import { useParams } from 'react-router';
import Scrollbar from 'react-smooth-scrollbar';
import { useGetRecoilValueInfo_UNSTABLE, useRecoilState, useRecoilValue, useSetRecoilState } from 'recoil';
import useDoubleClick from 'use-double-click';
import primaryAtom from '../../../shared/atom/primaryAtom';
import tablesDataAtom from '../../../shared/atom/tablesDataAtom';
import Colors from '../../../shared/colors';
import AppIcon from '../../../shared/components/AppIcon';
import DragAndDropMessage from '../../../shared/components/DragAndDropMessage';
import { useGetSubTables } from '../../../shared/query/tablesQueries';
import {
    isArray,
    isArrayOfObject,
    isArrayOrObjectAttribute,
    isAttribute,
    isAutoGenerated,
    isColumn,
    isDatabase,
    isInput,
    isItemSame,
    isObject,
    isOutput,
    isSchema,
    isStoredProcedure,
    operationAtomWithMiddleware,
    useCanEdit,
    useGetFullPath,
    useGetParentName,
    useWindowSize,
} from '../../../shared/utils';
import ArrayOfObjectsIcon from '../../../static/images/array-icon.svg';
import ArrayIcon from '../../../static/images/array.svg';
import ArrayIcon2 from '../../../static/images/array2.svg';
import AttributeIcon from '../../../static/images/attribute.svg';
import ColumnIcon from '../../../static/images/column-icon.svg';
import InputIcon from '../../../static/images/input.svg';
import ObjectIcon from '../../../static/images/object-icon.svg';
import OutputIcon from '../../../static/images/output.svg';
import SchemaIcon from '../../../static/images/schema-icon.svg';
import StoredProcedureIcon from '../../../static/images/stored-procedure.svg';
import TableIcon from '../../../static/images/table-icon.svg';
import ChangeColumnName from '../ChangeColumnName';
import DropArea from '../DropArea';
import ChangeNameInsideArray from './ChangeNameInsideArray';
import ChangeTableName from './ChangeTableName';
import DraggableBodyItem from './DraggableBodyItem';
import { useGetSubSchema, useGetTableData } from './requestBodyQueries';
import { useExpandedIds } from './utils';

const Body = ({ request = true, responseCode, projectType = 'schema', onDelete = () => {} }) => {
    let [operationData, setOperationDetails] = useRecoilState(operationAtomWithMiddleware);
    const [updatedData, setUpdateData] = useState(operationData);
    const [refresh, setRefresh] = React.useState(0);
    // operationData;

    const toggleRefresh = () => {
        setRefresh((old) => {
            const newState = old + 1;
            return newState;
        });
    };
    // operationData;
    const {
        isLoading: isLoadingSubSchema,
        error: getSubSchemasError,
        data: subSchemaData,
        mutate: getSubSchema,
        reset: resetSubSchemaData,
        variables: subSchemaRequest,
    } = useGetSubSchema();
    const { height, width } = useWindowSize();
    const { getExandedIds, setExpandedIds } = useExpandedIds([]);
    const [primaryKeyRef, setPrimaryKeyRef] = useRecoilState(primaryAtom);
    const tablesData = useRecoilValue(tablesDataAtom);
    const [disabledIcons, setDisabledIcons] = useState(false);
    const { fetch: fetchParentName } = useGetParentName();
    const { fetch: fetchFullPath } = useGetFullPath();

    const itemDropped = (item) => {
        let final_arr = [];

        if (
            isSchema(item) ||
            isDatabase(item) ||
            isAttribute(item) ||
            isColumn(item) ||
            isArrayOrObjectAttribute(item) ||
            isArray(item) ||
            isObject(item) ||
            isStoredProcedure(item) ||
            isInput(item) ||
            isOutput(item) ||
            isArrayOfObject(item)
        ) {
            setOperationDetails((operationDetails) => {
                const path = fetchFullPath(item);

                if (request) {
                    if (
                        !operationDetails.operationRequest.body.find((x) => isItemSame(x, item, path)) &&
                        isAutoGenerated(item, operationData)
                    ) {
                        const newOperationDetails = _.cloneDeep(operationDetails);
                        const clonedItem = _.cloneDeep(item);
                        if (isArrayOfObject(item) || isObject(item)) {
                            clonedItem.required = true;
                            clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                            clonedItem.parentName = path ?? '/';
                            if (clonedItem.ref && clonedItem.ref !== null) {
                                let str = '';
                                str = item.ref.split('.ezapi_object').join('');
                                str = str.split('.ezapi_array').join('');
                                str = str.split('.attribute').join('');
                                clonedItem.key = str;
                            }
                        }

                        if (isArray(item)) {
                            clonedItem.isArray = true;
                            clonedItem.is_child = true;
                            if (item?.id) {
                                clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                            }
                        }

                        if (isAttribute(item)) {
                            clonedItem.required = true;
                            clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                            clonedItem.parentName = path ?? '/';
                            if (clonedItem.ref && clonedItem.ref !== null) {
                                let str = '';
                                str = item.ref.split('.ezapi_object').join('');
                                str = str.split('.ezapi_array').join('');
                                str = str.split('.attributes').join('');
                                clonedItem.key = str;
                            }
                        } else if (isColumn(item)) {
                            clonedItem.tableName = fetchParentName(clonedItem) ?? 'global';
                            if (clonedItem.ref && clonedItem.ref !== null) {
                                let str = '';
                                str = item.ref.split('.ezapi_object').join('');
                                str = str.split('.ezapi_array').join('');
                                str = str.split('.attributes').join('');
                                clonedItem.key = str;
                            }
                        }
                        if (isColumn(item)) {
                            if (item?.foreign) {
                                final_arr.push(item?.foreign?.table);
                                let condition = tablesData
                                    .filter((table) => {
                                        return table.name === item.foreign.table;
                                    })[0]
                                    .selectedColumns.filter((column) => {
                                        return column.name === item.foreign.column;
                                    })[0];

                                while (condition?.foreign) {
                                    final_arr.push(condition.foreign.table);
                                    condition = tablesData
                                        .filter((table) => {
                                            return table.name === condition.foreign.table;
                                        })[0]
                                        .selectedColumns.filter((column) => {
                                            return column.name === condition.foreign.column;
                                        })[0];
                                }
                            } else {
                                final_arr = [];
                            }
                            // setPrimaryKeyRef(final_arr);
                        }

                        if (isStoredProcedure(item)) {
                            let inputExists = false;
                            item?.data?.[0]?.map((row) => {
                                if (row.type === 'input') {
                                    inputExists = true;
                                }
                            });
                            if (item['draggedFrom'] === 'input' && inputExists) {
                                clonedItem['inputAttributes'] = clonedItem.data[0];
                                clonedItem['required'] = true;
                                clonedItem['payloadId'] = null;
                                delete clonedItem.draggedFrom;
                                delete clonedItem.data;
                                delete clonedItem.contentType;
                            } else {
                                setUpdateData(newOperationDetails);
                                return newOperationDetails;
                            }
                        }

                        newOperationDetails.operationRequest.body.push(clonedItem);
                        setUpdateData(newOperationDetails);
                        return newOperationDetails;
                    }
                } else {
                    const responseData = getResponseData(operationDetails);
                    const responseIndex = getResponseIndex(operationDetails);

                    const existingBodyIndex = responseData?.body?.findIndex((x) => isItemSame(x, item, path));

                    if (existingBodyIndex === -1 && responseData && responseIndex >= 0) {
                        const clonedOperationDetails = _.cloneDeep(operationDetails);
                        const clonedResponseData = _.cloneDeep(responseData);
                        const clonedItem = _.cloneDeep(item);
                        if (isArrayOfObject(item) || isObject(item)) {
                            if (clonedItem.ref && clonedItem.ref !== null) {
                                let str = '';
                                str = item.ref.split('.ezapi_object').join('');
                                str = str.split('.ezapi_array').join('');
                                str = str.split('.attribute').join('');
                                clonedItem.key = str;
                            }

                            clonedItem.required = true;
                            clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                            clonedItem.parentName = path ?? '/';
                        }

                        if (isArray(item)) {
                            clonedItem.isArray = true;
                            clonedItem.is_child = true;
                            if (item?.id) {
                                clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                            }
                        }

                        if (isAttribute(item)) {
                            clonedItem.required = true;
                            clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                            clonedItem.parentName = path ?? '/';
                        } else if (isColumn(item)) {
                            clonedItem.tableName = fetchParentName(clonedItem) ?? 'global';
                        } /* else if (isArrayOrObjectAttribute(item) && isArray(item)) {
              clonedItem.tableName = fetchParentName(clonedItem) ?? "global";
            } */

                        if (isStoredProcedure(item)) {
                            let outputExists = false;
                            item?.data?.[1]?.map((row) => {
                                if (row.type === 'output') {
                                    outputExists = true;
                                }
                            });

                            if (item['draggedFrom'] === 'output' && outputExists) {
                                clonedItem['outputAttributes'] = clonedItem.data[1];
                                clonedItem['required'] = true;
                                clonedItem['payloadId'] = null;
                                delete clonedItem.draggedFrom;
                                delete clonedItem.data;
                                delete clonedItem.contentType;
                            } else {
                                setUpdateData(clonedOperationDetails);
                                return clonedOperationDetails;
                            }
                        }

                        clonedResponseData.body.push(clonedItem);

                        clonedOperationDetails.operationResponse[responseIndex] = clonedResponseData;
                        setUpdateData(clonedOperationDetails);

                        return clonedOperationDetails;
                    }
                }
                setUpdateData(operationDetails);

                return operationDetails;
            });
            toggleRefresh();
        }
    };

    const nestedItemDropped = (item, children) => {
        const data = children.props.children.props.itemRef;
        let valueDropped;
        let itemDroppedFromTop;

        if (item.props) {
            if (item.props.columnLabelItem) {
                valueDropped = item.props.columnLabelItem;
                itemDroppedFromTop = false;
            } else {
                valueDropped = item.props.itemRef;
                itemDroppedFromTop = false;
            }
        } else {
            valueDropped = item;
            itemDroppedFromTop = true;
        }

        setOperationDetails((operationDetails) => {
            const path = fetchFullPath(valueDropped);

            const newOperationDetails = _.cloneDeep(updatedData);
            const clonedItem = _.cloneDeep(valueDropped);
            const responseIndex = getResponseIndex(updatedData);

            if (isArray(valueDropped)) {
                clonedItem.isArray = true;
                clonedItem.is_child = true;
                if (valueDropped?.id) {
                    clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                }
            }

            if (isAttribute(valueDropped)) {
                clonedItem.required = true;
                clonedItem.schemaName = fetchParentName(clonedItem) ?? 'global';
                clonedItem.parentName = path ?? '/';
            } else if (isColumn(valueDropped)) {
                clonedItem.tableName = fetchParentName(clonedItem) ?? 'global';
            } /* else if (isArrayOrObjectAttribute(item) && isArray(item)) {
        clonedItem.tableName = fetchParentName(clonedItem) ?? "global";
      } */

            let requestOrResponseData = request
                ? newOperationDetails.operationRequest
                : newOperationDetails.operationResponse[responseIndex ?? 0];

            const newValue = requestOrResponseData?.body.filter((bodyItem) => {
                if (bodyItem.name === valueDropped.name) {
                    return bodyItem;
                }
            });

            if (newValue.length > 0) {
                valueDropped = newValue[0];
            }

            if (
                ((isColumn(valueDropped) || isDatabase(valueDropped) || isAttribute(valueDropped)) &&
                    (isArrayOfObject(data) || isObject(data))) ||
                ((isArray(valueDropped) ||
                    (isObject(valueDropped) && valueDropped.properties && !_.isEmpty(valueDropped.properties)) ||
                    (isArrayOfObject(valueDropped) &&
                        valueDropped.items &&
                        valueDropped.items.properties &&
                        !_.isEmpty(valueDropped.items.properties))) &&
                    isArrayOfObject(data) &&
                    data.id !== valueDropped.id) ||
                (((isObject(valueDropped) && valueDropped.properties && !_.isEmpty(valueDropped.properties)) ||
                    isArray(valueDropped) ||
                    (isArrayOfObject(valueDropped) &&
                        valueDropped.items &&
                        valueDropped.items.properties &&
                        !_.isEmpty(valueDropped.items.properties))) &&
                    isObject(data) &&
                    data.id !== valueDropped.id)
            ) {
                if (isObject(data)) {
                    requestOrResponseData?.body.map((bodyItem) => {
                        if (bodyItem.name === data.name) {
                            if (bodyItem.properties) {
                                bodyItem.properties[clonedItem.name] = clonedItem;
                            } else {
                                bodyItem.type = 'object';
                                bodyItem.properties = {};
                                bodyItem.properties[clonedItem.name] = clonedItem;
                            }
                        }
                    });
                } else if (isArrayOfObject(data)) {
                    requestOrResponseData?.body.map((bodyItem) => {
                        if (bodyItem.name === data.name) {
                            if (bodyItem.items) {
                                if (bodyItem.items.properties) {
                                    bodyItem.items.properties[clonedItem.name] = clonedItem;
                                } else {
                                    bodyItem.items.type = 'object';
                                    bodyItem.items.properties = {};
                                    bodyItem.items.properties[clonedItem.name] = clonedItem;
                                }
                            } else {
                                bodyItem.items = {};
                                bodyItem.items.properties = {};
                                bodyItem.items.type = 'object';
                                bodyItem.items.properties[clonedItem.name] = clonedItem;
                            }
                        }
                    });
                }
                if (!itemDroppedFromTop) {
                    requestOrResponseData.body.map((item, index) => {
                        if (item.payloadId && clonedItem.payloadId) {
                            if (item.payloadId === clonedItem.payloadId) {
                                requestOrResponseData.body.splice(index, 1);
                            }
                        } else if (item.id && clonedItem.id) {
                            if (item.id === clonedItem.id) {
                                requestOrResponseData.body.splice(index, 1);
                            }
                        }
                    });
                }
            }

            setUpdateData(newOperationDetails);
            return newOperationDetails;
        });

        toggleRefresh();
    };

    /* useEffect(() => {
    //
  }, [isLoadingSubSchema]); */

    const getResponseData = (operation) => {
        return operation?.operationResponse?.find((item) => item.responseCode === responseCode);
    };

    //useEffect(() => {}, [refresh]);

    const getResponseIndex = (operation) => {
        return operation?.operationResponse?.findIndex((item) => item.responseCode === responseCode);
    };

    return (
        <DropArea onItemDropped={itemDropped} state={refresh} key={refresh}>
            <div className=" h-full flex flex-col">
                <div className=" ml-3 p-2 border-t-2 border-b-2 bg-neutral-gray8 mb-1/2">
                    <div className=" w-full grid grid-cols-5 gap-2 ">
                        {projectType === 'db' && (
                            <>
                                {' '}
                                <div className="flex justify-self-start ">
                                    {' '}
                                    <p className="text-overline2 uppercase text-neutral-gray4 font-bold">
                                        Table/Column
                                    </p>
                                </div>
                            </>
                        )}
                        {projectType === 'noinput' && (
                            <>
                                {' '}
                                <div className="flex justify-self-start ">
                                    {' '}
                                    <p className="text-overline2 uppercase text-neutral-gray4 font-bold">Parameter</p>
                                </div>
                            </>
                        )}
                        <div className="flex justify-self-start ">
                            {projectType != 'noinput' && (
                                <p className="text-overline2 uppercase text-neutral-gray4 font-bold">
                                    Schema/Attribute
                                </p>
                            )}
                        </div>
                        <div className="flex justify-self-start ">
                            <p className="text-overline2 uppercase text-neutral-gray4 font-bold">Data Type</p>
                        </div>
                        <div className="flex justify-self-start ">
                            {' '}
                            <p className="text-overline2 uppercase text-neutral-gray4 font-bold">is Array</p>
                        </div>
                        <div className="flex justify-self-start ">
                            <p className="text-overline2 uppercase text-neutral-gray4 font-bold">Required</p>
                        </div>
                    </div>
                </div>

                {request && !_.isEmpty(updatedData?.operationRequest?.body) && (
                    <div className="h-full flex-1">
                        <Scrollbar
                            alwaysShowTracks={true}
                            style={{
                                maxHeight:
                                    height > 790 ? '26vh' : height > 770 ? '22vh' : height > 600 ? '18vh' : '13vh',
                            }}
                        >
                            <TreeView
                                defaultCollapseIcon={!disabledIcons ? <ExpandMoreIcon /> : null}
                                defaultExpandIcon={!disabledIcons ? <ChevronRightIcon /> : null}
                                expanded={getExandedIds() ?? null}
                                onNodeToggle={(event, nodeIds) => {
                                    setExpandedIds(nodeIds);
                                }}
                            >
                                {updatedData?.operationRequest?.body.map((item, index) => {
                                    let clonedRef;

                                    if (isSchema(item)) {
                                        clonedRef = _.cloneDeep(item);

                                        if (!clonedRef.hasOwnProperty('data')) {
                                            clonedRef['data'] = [];
                                        }
                                    } else if (isDatabase(item)) {
                                        clonedRef = _.cloneDeep(item);

                                        if (!clonedRef.hasOwnProperty('selectedColumns')) {
                                            clonedRef['selectedColumns'] = [];
                                        }
                                    } else if (isStoredProcedure(item)) {
                                        clonedRef = _.cloneDeep(item);
                                    } else if (isArray(item) || isArrayOfObject(item) || isObject(item)) {
                                        clonedRef = _.cloneDeep(item);
                                    }

                                    return clonedRef === 'wrongData' ? null : (
                                        <DropArea onItemDropped={nestedItemDropped} state={refresh}>
                                            <DraggableBodyItem state={refresh}>
                                                <BodyItem
                                                    disabledIcons={(value) => {
                                                        setDisabledIcons(false);
                                                    }}
                                                    projectType={projectType}
                                                    /* key={
                            index +
                            // operationData?.operationRequest?.body.length +
                            refresh
                          } */
                                                    itemRef={clonedRef ?? item}
                                                    request={request}
                                                    responseCode={responseCode}
                                                    refresh={() => {
                                                        toggleRefresh();
                                                    }}
                                                    onUpdate={(data) => {
                                                        setUpdateData(data);
                                                    }}
                                                    onDelete={() => {
                                                        onDelete();
                                                    }}
                                                />
                                            </DraggableBodyItem>
                                        </DropArea>
                                    );
                                })}
                            </TreeView>
                        </Scrollbar>
                    </div>
                )}

                {!request && !_.isEmpty(getResponseData(updatedData)?.body) && (
                    <div className="h-full flex-1">
                        <Scrollbar
                            alwaysShowTracks={true}
                            style={{
                                maxHeight:
                                    height > 790 ? '23vh' : height > 770 ? '19vh' : height > 600 ? '15vh' : '10vh',
                            }}
                        >
                            <TreeView
                                defaultCollapseIcon={<ExpandMoreIcon />}
                                defaultExpandIcon={<ChevronRightIcon />}
                                expanded={getExandedIds() ?? []}
                                onNodeToggle={(event, nodeIds) => {
                                    setExpandedIds(nodeIds);
                                }}
                            >
                                {getResponseData(updatedData)?.body.map((item, index) => {
                                    let clonedRef;

                                    if (isSchema(item)) {
                                        clonedRef = _.cloneDeep(item);

                                        if (!clonedRef.hasOwnProperty('data')) {
                                            clonedRef['data'] = [];
                                        }
                                    } else if (isDatabase(item)) {
                                        clonedRef = _.cloneDeep(item);

                                        if (!clonedRef.hasOwnProperty('selectedColumns')) {
                                            clonedRef['selectedColumns'] = [];
                                        }
                                    } else if (isStoredProcedure(item)) {
                                        clonedRef = _.cloneDeep(item);
                                    } else if (isArray(item) || isArrayOfObject(item) || isObject(item)) {
                                        clonedRef = _.cloneDeep(item);
                                    }

                                    return clonedRef === 'wrongData' ? null : (
                                        <DropArea onItemDropped={nestedItemDropped} state={refresh}>
                                            <DraggableBodyItem state={refresh}>
                                                <BodyItem
                                                    projectType={projectType}
                                                    /* key={
                            index +
                            // getResponseData(operationData)?.body.length +
                            refresh
                          } */
                                                    itemRef={clonedRef ?? item}
                                                    request={request}
                                                    responseCode={responseCode}
                                                    refresh={() => {
                                                        toggleRefresh();
                                                    }}
                                                    onUpdate={(data) => {
                                                        setUpdateData(data);
                                                    }}
                                                    onDelete={() => {
                                                        onDelete();
                                                    }}
                                                />
                                            </DraggableBodyItem>
                                        </DropArea>
                                    );
                                })}
                            </TreeView>
                        </Scrollbar>
                    </div>
                )}

                {request && _.isEmpty(operationData?.operationRequest?.body) && (
                    <div className="border-dashed p-3 bg-neutral-gray7 rounded-md border-2 m-2 flex flex-row justify-center">
                        <DragAndDropMessage isSchemaAllowed isAttributeAllowed />
                    </div>
                )}

                {!request && _.isEmpty(getResponseData(operationData)?.body) && (
                    <div className="border-dashed p-3 bg-neutral-gray7 rounded-md border-2 m-2 flex flex-row justify-center">
                        <DragAndDropMessage isTableAllowed isColumnAllowed />
                    </div>
                )}
            </div>
        </DropArea>
    );
};

let treeIndex = 1;
const truncateLength = 20; //max character length limit of names to enable truncate
// This can either be a schema or table or stored procedure
const BodyItem = ({
    request = true,
    responseCode,
    itemRef,
    projectType,
    disabledIcons,
    onUpdate = () => {},
    refresh = () => {},
    onDelete = () => {},
}) => {
    const [bodyItem, setItem] = useState(itemRef);
    const [arrayData, setArrayData] = useState(itemRef.data ?? []);
    const setOperationDetails = useSetRecoilState(operationAtomWithMiddleware);
    const { projectId } = useParams();
    const {
        isLoading: isLoadingSubSchema,
        error: getSubSchemasError,
        data: subSchemaData,
        mutate: getSubSchema,
        reset: resetSubSchemaData,
        variables: subSchemaRequest,
    } = useGetSubSchema();
    const {
        isLoading: isLoadingSubTable,
        error: getSubTablesError,
        data: subTableData,
        mutate: getSubTable,
        reset: resetSubTableData,
        isIdle: isGetSubTableIdle,
    } = useGetSubTables();
    const { isLoading: isLoadingTableData, data: tableData, mutate: getTable } = useGetTableData();
    const canEdit = useCanEdit();
    const getRecoilValueInfo = useGetRecoilValueInfo_UNSTABLE();

    useEffect(() => {
        if (tableData) {
            setItem(tableData);
        }
    }, [tableData]);

    useEffect(() => {
        setItem(itemRef);
        if ((itemRef.items && itemRef.items.properties) || itemRef.properties) {
            getArrayData();
        }
    }, [itemRef]);

    const deleteItemsInsideNestedItems = (child, parent, root) => {
        if (
            isDatabase(child) ||
            isColumn(child) ||
            isAttribute(child) ||
            isArray(child) ||
            isObject(child) ||
            isArrayOfObject(child)
        ) {
            if (
                (isObject(parent) && Object.keys(parent.properties).length === 1) ||
                (isArrayOfObject(parent) && Object.keys(parent.items?.properties).length === 1)
            ) {
                onDelete();
            } else {
                setOperationDetails((operationDetails) => {
                    const newOperationDetails = _.cloneDeep(operationDetails);
                    const responseIndex = getResponseIndex(operationDetails);
                    let data = request
                        ? newOperationDetails.operationRequest
                        : newOperationDetails.operationResponse[responseIndex];

                    const index = data.body.findIndex((x) => x?.name === root?.name);

                    if (index !== -1) {
                        if (data.body[index].items && data.body[index].items?.properties) {
                            if (data.body[index].items?.properties[parent.name].items?.properties) {
                                delete data.body[index].items?.properties[parent.name].items?.properties[child.name];
                            }

                            if (data.body[index].items?.properties[parent.name].properties) {
                                delete data.body[index].items?.properties[parent.name].properties[child.name];
                            }
                        }
                        if (data.body[index].properties) {
                            if (data.body[index].properties[parent.name].items?.properties) {
                                delete data.body[index].properties[parent.name].items?.properties[child.name];
                            }

                            if (data.body[index].properties[parent.name].properties) {
                                delete data.body[index].properties[parent.name].properties[child.name];
                            }
                        }
                        onUpdate(newOperationDetails);
                        return newOperationDetails;
                    }
                });
            }
        }
        refresh();
    };

    const getResponseIndex = (operation) => {
        return operation?.operationResponse?.findIndex((item) => item.responseCode === responseCode);
    };

    const deleteNestedItems = (item, array) => {
        if (
            isDatabase(item) ||
            isColumn(item) ||
            isAttribute(item) ||
            isArray(item) ||
            isObject(item) ||
            isArrayOfObject(item)
        ) {
            setOperationDetails((operationDetails) => {
                const newOperationDetails = _.cloneDeep(operationDetails);
                const responseIndex = getResponseIndex(operationDetails);

                let data = request
                    ? newOperationDetails.operationRequest
                    : newOperationDetails.operationResponse[responseIndex];

                const index = data.body.findIndex((x) => x?.name === array?.name);

                if (index !== -1) {
                    if (data.body[index].items?.properties) {
                        delete data.body[index].items?.properties[item.name];
                        // let newData = arrayData.filter((value) => value !== item.name)
                        // setArrayData(newData)
                        // refresh()
                    }
                    if (data.body[index].properties) {
                        delete data.body[index].properties[item.name];
                        // let newData = arrayData.filter((value) => value !== item.name)
                        // setArrayData(newData)
                        // refresh()
                    }

                    onUpdate(newOperationDetails);
                    return newOperationDetails;
                }
            });
        }
        refresh();
    };

    const deleteItem = (item) => {
        if (
            isArray(item) ||
            isSchema(item) ||
            isColumn(item) ||
            isAttribute(item) ||
            isDatabase(item) ||
            isStoredProcedure(item) ||
            isArrayOfObject(item) ||
            isObject(item) ||
            (isArrayOrObjectAttribute(item) && canEdit())
        ) {
            setOperationDetails((operationDetails) => {
                if (request) {
                    const index = operationDetails.operationRequest.body.findIndex((x) => x?.name === item?.name);
                    if (index !== -1) {
                        const newOperationDetails = _.cloneDeep(operationDetails);

                        newOperationDetails.operationRequest.body.splice(index, 1);

                        onUpdate(newOperationDetails);

                        return newOperationDetails;
                    }
                } else {
                    const responseData = operationDetails?.operationResponse?.find(
                        (item) => item.responseCode === responseCode,
                    );
                    const responseIndex = operationDetails?.operationResponse?.findIndex(
                        (item) => item.responseCode === responseCode,
                    );

                    const existingBodyIndex = responseData?.body?.findIndex(
                        // (body) => body?.sourceName === item?.sourceName
                        (body) => body?.name === item?.name,
                    );

                    if (existingBodyIndex >= 0 && responseData && responseIndex >= 0) {
                        const clonedOperationDetails = _.cloneDeep(operationDetails);
                        const clonedResponseData = _.cloneDeep(responseData);

                        clonedResponseData.body.splice(existingBodyIndex, 1);

                        clonedOperationDetails.operationResponse[responseIndex] = clonedResponseData;

                        onUpdate(clonedOperationDetails);

                        return clonedOperationDetails;
                    }
                }

                return operationDetails;
            });
        }
        refresh();
    };

    const isArrayChecked = (item, isArrayValue, reqType) => {
        setOperationDetails((operationDetails) => {
            if (request) {
                var requestData = null;
                var requestIndex = null;
                operationDetails?.operationRequest?.body.map((row, index) => {
                    if (row.payloadId === item.payloadId) {
                        requestData = row;
                        requestIndex = index;
                    }
                });

                if (requestData && requestIndex >= 0) {
                    const clonedOperationDetails = _.cloneDeep(operationDetails);
                    const clonedRequestData = _.cloneDeep(requestData);

                    clonedRequestData.isArray = isArrayValue;
                    //clonedRequestData.type = "object"; //remove to avoid making it object
                    //clonedRequestData.format = "object"; //remove to avoid making it object
                    clonedOperationDetails.operationRequest.body[requestIndex] = clonedRequestData;
                    onUpdate(clonedOperationDetails);

                    return clonedOperationDetails;
                }
            } else {
                const responseData = operationDetails?.operationResponse?.find(
                    (item) => item.responseCode === responseCode,
                );
                const responseIndex = operationDetails?.operationResponse?.findIndex(
                    (item) => item.responseCode === responseCode,
                );

                // const existingBodyIndex = responseData?.body?.findIndex(
                //   // (body) => body?.sourceName === item?.sourceName
                //   (body) => body?.name === item?.name
                // );
                const tableIndex = responseData?.body?.findIndex((body) => body?.sourceName === item?.sourceName);
                if (tableIndex >= 0 && responseData && responseIndex >= 0) {
                    const clonedOperationDetails = _.cloneDeep(operationDetails);
                    const clonedResponseData = _.cloneDeep(responseData);
                    //  const clonedTable = _.cloneDeep(clonedResponseData.body[tableIndex]);
                    clonedResponseData.body[tableIndex].isArray = isArrayValue;

                    clonedOperationDetails.operationResponse[responseIndex] = clonedResponseData;
                    onUpdate(clonedOperationDetails);

                    return clonedOperationDetails;
                }
            }

            return operationDetails;
        });
    };

    const deleteColumnOfTable = (column, table, isObjectArray = false, ref) => {
        if (isObjectArray) {
            let array = _.cloneDeep(table);
            if (array.items?.properties) {
                table = array.items.properties[ref.name];
            } else if (array.properties) {
                table = array.properties[ref.name];
            }
            if (isColumn(column) && isDatabase(table)) {
                setOperationDetails((operationDetails) => {
                    const newOperationDetails = _.cloneDeep(operationDetails);
                    const responseIndex = getResponseIndex(operationDetails);
                    let data = request
                        ? newOperationDetails.operationRequest
                        : newOperationDetails.operationResponse[responseIndex];
                    const arrayIndex = data.body.findIndex(
                        (x) => (isArrayOfObject(x) || isObject(x)) && x.name === array.name,
                    );
                    if (data.body[arrayIndex]?.items?.properties) {
                        const columnIndex =
                            data.body[arrayIndex].items.properties[ref.name].selectedColumns.findIndex(
                                (x) => isColumn(x) && x?.sourceName === column?.sourceName,
                            ) ?? -1;

                        if (columnIndex !== -1) {
                            data.body[arrayIndex].items.properties[ref.name].selectedColumns.splice(columnIndex, 1);
                        }
                    }

                    if (data.body[arrayIndex]?.properties) {
                        const columnIndex =
                            data.body[arrayIndex].properties[ref.name].selectedColumns.findIndex(
                                (x) => isColumn(x) && x?.sourceName === column?.sourceName,
                            ) ?? -1;

                        if (columnIndex !== -1) {
                            data.body[arrayIndex].properties[ref.name].selectedColumns.splice(columnIndex, 1);
                        }
                    }

                    onUpdate(newOperationDetails);
                    return newOperationDetails;
                });
            }
        } else {
            if (isColumn(column) && isDatabase(table) && canEdit()) {
                setOperationDetails((operationDetails) => {
                    if (request) {
                        const newOperationDetails = _.cloneDeep(operationDetails);

                        const tableIndex = newOperationDetails.operationRequest.body.findIndex(
                            (x) => isDatabase(x) && x?.sourceName === table?.sourceName,
                        );

                        if (tableIndex !== -1) {
                            const clonedTable = _.cloneDeep(newOperationDetails.operationRequest.body[tableIndex]);

                            const columnIndex =
                                clonedTable?.selectedColumns?.findIndex(
                                    (x) => isColumn(x) && x?.sourceName === column?.sourceName,
                                ) ?? -1;

                            if (columnIndex !== -1) {
                                clonedTable.selectedColumns.splice(columnIndex, 1);
                            }

                            newOperationDetails.operationRequest.body[tableIndex] = clonedTable;

                            onUpdate(newOperationDetails);

                            return newOperationDetails;
                        }
                    } else {
                        const responseData = operationDetails?.operationResponse?.find(
                            (item) => item.responseCode === responseCode,
                        );
                        const responseIndex = operationDetails?.operationResponse?.findIndex(
                            (item) => item.responseCode === responseCode,
                        );

                        const tableIndex = responseData?.body?.findIndex(
                            (body) => body?.sourceName === table?.sourceName,
                        );

                        if (tableIndex >= 0 && responseData && responseIndex >= 0) {
                            const clonedOperationDetails = _.cloneDeep(operationDetails);
                            const clonedResponseData = _.cloneDeep(responseData);
                            const clonedTable = _.cloneDeep(clonedResponseData.body[tableIndex]);

                            const columnIndex =
                                clonedTable?.selectedColumns?.findIndex(
                                    (x) => isColumn(x) && x?.sourceName === column?.sourceName,
                                ) ?? -1;

                            if (columnIndex !== -1) {
                                clonedTable.selectedColumns.splice(columnIndex, 1);
                            }

                            clonedResponseData.body[tableIndex] = clonedTable;

                            clonedOperationDetails.operationResponse[responseIndex] = clonedResponseData;

                            onUpdate(clonedOperationDetails);

                            return clonedOperationDetails;
                        }
                    }

                    return operationDetails;
                });
            }
        }
        refresh();
    };

    const renameColumn = (column, name) => {
        if (canEdit()) {
            setOperationDetails((operationDetails) => {
                if (request) {
                    const newOperationDetails = _.cloneDeep(operationDetails);

                    // Get column index
                    const columnIndex = newOperationDetails.operationRequest.body.findIndex(
                        (bodyItem) => column?.sourceName === bodyItem?.sourceName,
                    );

                    if (columnIndex !== -1) {
                        // Clone column
                        const clonedColumn = _.cloneDeep(newOperationDetails.operationRequest.body[columnIndex]);

                        // Set updated name to column
                        clonedColumn.name = name;

                        // Set cloned column to body
                        newOperationDetails.operationRequest.body[columnIndex] = clonedColumn;

                        onUpdate(newOperationDetails);

                        return newOperationDetails;
                    }
                } else {
                    const responseIndex = operationDetails?.operationResponse?.findIndex(
                        (item) => item.responseCode === responseCode,
                    );

                    if (responseIndex !== -1) {
                        const clonedOperationDetails = _.cloneDeep(operationDetails);
                        const clonedResponseData = _.cloneDeep(operationDetails?.operationResponse[responseIndex]);

                        // Get column
                        const columnIndex = clonedResponseData?.body?.findIndex(
                            (bodyItem) => column?.sourceName === bodyItem?.sourceName,
                        );

                        if (columnIndex !== -1) {
                            // Clone column
                            const clonedColumn = _.cloneDeep(clonedResponseData?.body[columnIndex]);

                            // Set updated name to column
                            clonedColumn.name = name;

                            // Set cloned column to body
                            clonedResponseData.body[columnIndex] = clonedColumn;
                        }

                        clonedOperationDetails.operationResponse[responseIndex] = clonedResponseData;

                        onUpdate(clonedOperationDetails);

                        return clonedOperationDetails;
                    }
                }

                return operationDetails;
            });
            refresh();
        }
    };

    const isNameTaken = (item, name) => {
        if (canEdit()) {
            const { loadable: operationAtom } = getRecoilValueInfo(operationAtomWithMiddleware);
            const operationDetails = operationAtom?.contents;

            if (request) {
                const newOperationDetails = _.cloneDeep(operationDetails);

                // Get column index
                const columnIndex = newOperationDetails.operationRequest.body.findIndex(
                    (bodyItem) => bodyItem?.name === name && bodyItem?.sourceName !== item?.sourceName,
                );

                if (columnIndex !== -1) {
                    return true;
                }
            } else {
                const responseIndex = operationDetails?.operationResponse?.findIndex(
                    (item) => item.responseCode === responseCode,
                );

                if (responseIndex !== -1) {
                    // Get column
                    const columnIndex = operationDetails?.operationResponse[responseIndex]?.body?.findIndex(
                        (bodyItem) => bodyItem?.name === name && bodyItem?.sourceName !== item?.sourceName,
                    );

                    if (columnIndex !== -1) {
                        return true;
                    }
                }
            }

            return false;
        }

        return false;
    };

    const renameColumnOfTable = (column, table, name, isObjectArray = false, ref) => {
        if (isObjectArray) {
            let array = _.cloneDeep(table);
            if (array.items?.properties) {
                table = array.items.properties[ref.name];
            } else if (array.properties) {
                table = array.properties[ref.name];
            }
            if (isColumn(column) && isDatabase(table) && (isArrayOfObject(array) || isObject(array))) {
                setOperationDetails((operationDetails) => {
                    const newOperationDetails = _.cloneDeep(operationDetails);
                    const responseIndex = getResponseIndex(operationDetails);
                    let data = request
                        ? newOperationDetails.operationRequest
                        : newOperationDetails.operationResponse[responseIndex];
                    const arrayIndex = data.body.findIndex(
                        (x) => (isArrayOfObject(x) || isObject(x)) && x.name === array.name,
                    );

                    if (data.body[arrayIndex]?.items?.properties) {
                        const columnIndex =
                            data.body[arrayIndex].items.properties[ref.name].selectedColumns.findIndex(
                                (x) => isColumn(x) && x?.sourceName === column.sourceName,
                            ) ?? -1;

                        if (columnIndex !== -1) {
                            data.body[arrayIndex].items.properties[ref.name].selectedColumns[columnIndex].name = name;
                        }
                    }

                    if (data.body[arrayIndex]?.properties) {
                        const columnIndex =
                            data.body[arrayIndex].properties[ref.name].selectedColumns.findIndex(
                                (x) => isColumn(x) && x?.sourceName === column.sourceName,
                            ) ?? -1;

                        if (columnIndex !== -1) {
                            data.body[arrayIndex].properties[ref.name].selectedColumns[columnIndex].name = name;
                        }
                    }
                    onUpdate(newOperationDetails);
                    return newOperationDetails;
                });
            }
        } else {
            if (canEdit()) {
                setOperationDetails((operationDetails) => {
                    if (request) {
                        const newOperationDetails = _.cloneDeep(operationDetails);

                        // Get parent table index
                        const parentTableIndex = newOperationDetails.operationRequest.body.findIndex(
                            (bodyItem) => isDatabase(bodyItem) && table?.sourceName === bodyItem?.sourceName,
                        );

                        if (parentTableIndex !== -1) {
                            // Clone parent table
                            const clonedParentTable = _.cloneDeep(
                                newOperationDetails.operationRequest.body[parentTableIndex],
                            );

                            // Get column
                            const columnIndex = clonedParentTable?.selectedColumns?.findIndex(
                                (columnItem) => column?.sourceName === columnItem?.sourceName,
                            );

                            if (columnIndex !== -1) {
                                // Clone column
                                const clonedColumn = _.cloneDeep(clonedParentTable.selectedColumns[columnIndex]);

                                // Set updated name to column
                                clonedColumn.name = name;

                                // Set cloned column to table
                                clonedParentTable.selectedColumns[columnIndex] = clonedColumn;

                                // Set table to operations body
                                newOperationDetails.operationRequest.body[parentTableIndex] = clonedParentTable;
                            }
                            onUpdate(newOperationDetails);
                            return newOperationDetails;
                        }
                    } else {
                        const responseIndex = operationDetails?.operationResponse?.findIndex(
                            (item) => item.responseCode === responseCode,
                        );
                        if (responseIndex !== -1) {
                            const responseData = operationDetails?.operationResponse[responseIndex];
                            const clonedOperationDetails = _.cloneDeep(operationDetails);
                            const clonedResponseData = _.cloneDeep(responseData);

                            const tableIndex = responseData?.body?.findIndex(
                                (body) => body?.sourceName === table?.sourceName,
                            );

                            if (tableIndex !== -1) {
                                const clonedTableData = _.cloneDeep(clonedResponseData.body[tableIndex]);

                                // Get column
                                const columnIndex = clonedTableData?.selectedColumns?.findIndex(
                                    (columnItem) => column?.sourceName === columnItem?.sourceName,
                                );

                                if (columnIndex !== -1) {
                                    // Clone column
                                    const clonedColumn = _.cloneDeep(clonedTableData.selectedColumns[columnIndex]);

                                    // Set updated name to column
                                    clonedColumn.name = name;

                                    // Set cloned column to table
                                    clonedTableData.selectedColumns[columnIndex] = clonedColumn;

                                    // Set table to response data body
                                    clonedResponseData.body[tableIndex] = clonedTableData;
                                }

                                clonedOperationDetails.operationResponse[responseIndex] = clonedResponseData;
                                onUpdate(clonedOperationDetails);

                                return clonedOperationDetails;
                            }
                        }
                    }

                    return operationDetails;
                });
            }
        }
        refresh();
    };

    const isColumnNameTakenOfTable = (column, table, name, isObjectArray = false, ref) => {
        if (isObjectArray) {
            const { loadable: operationAtom } = getRecoilValueInfo(operationAtomWithMiddleware);
            const operationDetails = operationAtom?.contents;

            let array = _.cloneDeep(table);
            if (array.items?.properties) {
                table = array.items.properties[ref.name];
            } else if (array.properties) {
                table = array.properties[ref.name];
            }
            if (isColumn(column) && isDatabase(table) && (isArrayOfObject(array) || isObject(array))) {
                const newOperationDetails = _.cloneDeep(operationDetails);
                const responseIndex = getResponseIndex(operationDetails);

                let data = request
                    ? newOperationDetails.operationRequest
                    : newOperationDetails.operationResponse[responseIndex];
                const arrayIndex = data.body.findIndex(
                    (x) => (isArrayOfObject(x) || isObject(x)) && x.name === array.name,
                );

                if (data.body[arrayIndex]?.items?.properties) {
                    const columnIndex =
                        data.body[arrayIndex].items.properties[ref.name].selectedColumns.findIndex(
                            (x) => isColumn(x) && x?.sourceName === name,
                        ) ?? -1;

                    if (columnIndex !== -1) {
                        return true;
                    }
                }

                if (data.body[arrayIndex]?.properties) {
                    const columnIndex =
                        data.body[arrayIndex].properties[ref.name].selectedColumns.findIndex(
                            (x) => isColumn(x) && x?.sourceName === name,
                        ) ?? -1;

                    if (columnIndex !== -1) {
                        return true;
                    }
                }
            }
        } else {
            if (canEdit()) {
                const { loadable: operationAtom } = getRecoilValueInfo(operationAtomWithMiddleware);
                const operationDetails = operationAtom?.contents;

                if (request) {
                    const newOperationDetails = _.cloneDeep(operationDetails);

                    // Get parent table index
                    const parentTableIndex = newOperationDetails.operationRequest.body.findIndex(
                        (bodyItem) => isDatabase(bodyItem) && table?.sourceName === bodyItem?.sourceName,
                    );

                    if (parentTableIndex !== -1) {
                        // Get column
                        const columnIndex = newOperationDetails.operationRequest.body[
                            parentTableIndex
                        ]?.selectedColumns?.findIndex((columnItem) => {
                            return columnItem?.name === name && columnItem?.sourceName !== column?.sourceName;
                        });

                        if (columnIndex !== -1) {
                            return true;
                        }
                    }
                } else {
                    const responseIndex = operationDetails?.operationResponse?.findIndex(
                        (item) => item.responseCode === responseCode,
                    );

                    if (responseIndex !== -1) {
                        const responseData = operationDetails?.operationResponse[responseIndex];

                        const tableIndex = responseData?.body?.findIndex(
                            (body) => body?.sourceName === table?.sourceName,
                        );

                        if (tableIndex !== -1) {
                            // Get column
                            const columnIndex = responseData.body[tableIndex]?.selectedColumns?.findIndex(
                                (columnItem) =>
                                    columnItem?.name === name && columnItem?.sourceName !== column?.sourceName,
                            );

                            if (columnIndex !== -1) {
                                return true;
                            }
                        }
                    }
                }
            }
        }

        return false;
    };

    const getSchemaData = (schemaRef) => {
        if (!isLoadingSubSchema && _.isEmpty(schemaRef.data)) {
            getSubSchema({
                projectId,
                name: schemaRef?.schemaName ?? schemaRef?.name,
                type: schemaRef?.type,
                ref: schemaRef?.ref,
            });
        }
    };

    useEffect(() => {
        if (subTableData && subTableData.data) {
            setArrayData(subTableData.data);
        }
    }, [subTableData]);

    useEffect(() => {
        if (subSchemaData) {
            if (subSchemaData.data) {
                setArrayData(subSchemaData?.data ?? []);
            } else {
                setArrayData(subSchemaData?.nSchemaArray[0]?.data ?? []);
            }
        }
    }, [subSchemaData]);

    const getTableData = (tableRef) => {
        if (!isLoadingTableData && _.isEmpty(tableRef.selectedColumns)) {
            getTable({
                projectId,
                ref: tableRef?.name,
            });
        }
    };

    const getArrayData = () => {
        if (bodyItem.items?.properties) {
            const arr = Object.keys(bodyItem.items.properties);
            setArrayData(arr);
        } else if (bodyItem.properties) {
            const arr = Object.keys(bodyItem.properties);
            setArrayData(arr);
        }
    };

    const getSubTableData = (item) => {
        let newRef = '';

        if (isObject(item)) {
            if (item.ref && item.ref !== null) {
                newRef = `${item.ref}.${item.name}.ezapi_object`;
            } else {
                newRef = `${item.tableName}.attributes.${item.name}.ezapi_object`;
            }
        } else if (isArray(item)) {
            if (item.ref && item.ref !== null) {
                newRef = `${item.ref}.${item.name}.ezapi_array.ezapi_object`;
            } else {
                newRef = `${item.tableName}.attributes.${item.name}.ezapi_array.ezapi_object`;
            }
        }

        getSubTable({
            projectId,
            name: item?.name,
            type: item?.type,
            ref: newRef,
        });
    };

    const onItemClick = () => {
        if (isDatabase(bodyItem) && tableData === undefined) {
            if (!bodyItem?.selectedColumns || _.isEmpty(bodyItem?.selectedColumns)) {
                getTableData(bodyItem);
            }
        } else if (isArrayOfObject(bodyItem)) {
            getArrayData();
        } else if (isObject(bodyItem) && bodyItem.properties) {
            getArrayData();
        } else if (
            (isArray(bodyItem) || isObject(bodyItem)) &&
            bodyItem.is_child === false &&
            projectType === 'db' &&
            subTableData === undefined
        ) {
            getSubTableData(bodyItem);
        } else if (
            (isSchema(bodyItem) || (isArray(bodyItem) && bodyItem.is_child === false)) &&
            projectType === 'both' &&
            subSchemaData === undefined
        ) {
            getSchemaData(bodyItem);
        }
    };

    if (isColumn(bodyItem)) {
        return (
            <DraggableBodyItem>
                <ColumnLabel
                    columnLabelItem={bodyItem}
                    deleteColumn={deleteItem}
                    renameColumn={renameColumn}
                    isNameTaken={isNameTaken}
                    request={request}
                    responseCode={responseCode}
                    isPartOfTable={false}
                />
            </DraggableBodyItem>
        );
    }

    if (isAttribute(bodyItem)) {
        return (
            <AttributeLabel
                labelItem={bodyItem}
                deleteItem={deleteItem}
                request={request}
                responseCode={responseCode}
                projectType={projectType}
            />
        );
    }

    if (isArray(bodyItem) && bodyItem.is_child) {
        return (
            <ArrayOrObjectLabel
                labelItem={bodyItem}
                isArrayChecked={isArrayChecked}
                deleteItem={deleteItem}
                request={request}
                responseCode={responseCode}
                projectType={projectType}
            />
        );
    }

    return (
        <TreeItem
            /* key={bodyItem?.payloadId ?? bodyItem?.name ?? treeIndex++}
      nodeId={bodyItem?.payloadId ?? bodyItem?.name ?? treeIndex++} */
            key={
                bodyItem?.payloadId
                    ? bodyItem?.payloadId + 'level1'
                    : bodyItem?.name
                    ? bodyItem?.name + 'level1'
                    : treeIndex++ + 'level1'
            }
            nodeId={
                bodyItem?.payloadId
                    ? bodyItem?.payloadId + 'level1'
                    : bodyItem?.name
                    ? bodyItem?.name + 'level1'
                    : treeIndex++ + 'level1'
            }
            label={
                isDatabase(bodyItem) ? (
                    <DatabaseLabel
                        tableLabelItem={bodyItem}
                        deleteItem={deleteItem}
                        isArrayChecked={isArrayChecked}
                        request={request}
                        responseCode={responseCode}
                        onUpdate={(data) => {
                            onUpdate(data);
                            refresh();
                        }}
                    />
                ) : bodyItem != 'wrongData' && isStoredProcedure(bodyItem) ? (
                    <StoredProcedureLabel
                        storedProcedureLabelItem={bodyItem}
                        deleteItem={deleteItem}
                        isArrayChecked={isArrayChecked}
                        request={request}
                        onUpdate={(data) => {
                            onUpdate(data);
                            refresh();
                        }}
                        responseCode={responseCode}
                    />
                ) : isArray(bodyItem) || isArrayOfObject(bodyItem) || isObject(bodyItem) ? (
                    <ArrayOrObjectLabel
                        labelItem={bodyItem}
                        isArrayChecked={isArrayChecked}
                        deleteItem={deleteItem}
                        request={request}
                        responseCode={responseCode}
                        projectType={projectType}
                    />
                ) : isSchema(bodyItem) ? (
                    <SchemaLabel
                        labelItem={bodyItem}
                        deleteItem={deleteItem}
                        isArrayChecked={isArrayChecked}
                        isLoading={isLoadingSubSchema}
                        request={request}
                        responseCode={responseCode}
                    />
                ) : null
            }
            onLabelClick={(e) => {
                e.preventDefault();
                e.stopPropagation();

                onItemClick();
            }}
            onIconClick={(e) => {
                onItemClick();
            }}
        >
            {isSchema(bodyItem) &&
                arrayData.map((ref) => {
                    // Sub schema/array/object
                    if (isSchema(ref) || isArray(ref) || isObject(ref)) {
                        const clonedRef = _.cloneDeep(ref);

                        if (!clonedRef.hasOwnProperty('data')) {
                            clonedRef['data'] = [];
                        }

                        if (!clonedRef.hasOwnProperty('isLoaded')) {
                            clonedRef['isLoaded'] = false;
                        }

                        return <BodySubTreeItems currentRef={clonedRef} projectType={projectType} />;
                    }
                    //attributes within a schema
                    else if (isAttribute(ref)) {
                        return (
                            <TreeItem
                                /* key={ref?.payloadId ?? ref?.name ?? treeIndex++}
                nodeId={ref?.payloadId ?? ref?.name ?? treeIndex++} */
                                key={
                                    ref?.payloadId
                                        ? ref?.payloadId + 'level2'
                                        : ref?.name
                                        ? ref?.name + 'level2'
                                        : treeIndex++ + 'level2'
                                }
                                nodeId={
                                    ref?.payloadId
                                        ? ref?.payloadId + 'level2'
                                        : ref?.name
                                        ? ref?.name + 'level2'
                                        : treeIndex++ + 'level2'
                                }
                                label={
                                    <div className="flex flex-row p-1 justify-between items-center border-b-2 h-8">
                                        <div className="flex flex-row items-center justify-start w-full">
                                            <div className="w-full grid grid-cols-5 gap-2 items-center ">
                                                <div className="flex justify-self-start items-center">
                                                    {' '}
                                                    <img
                                                        src={AttributeIcon}
                                                        alt="conektto logo"
                                                        className="bg-white mr-2"
                                                        style={{
                                                            height: '24px',
                                                            width: '24px',
                                                        }}
                                                    />
                                                    <p className="text-overline2">{ref?.name}</p>
                                                </div>

                                                <div className="flex-1">
                                                    <p>{ref?.type}</p>
                                                </div>
                                                <div> </div>
                                                <div className="flex-1"></div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            />
                        );
                    }
                })}

            {(isArray(bodyItem) || isObject(bodyItem)) &&
                !bodyItem.properties &&
                bodyItem.is_child === false &&
                arrayData.map((item) => {
                    const clonedRef = _.cloneDeep(item);

                    if (!clonedRef.hasOwnProperty('data')) {
                        clonedRef['data'] = [];
                    }

                    if (!clonedRef.hasOwnProperty('isLoaded')) {
                        clonedRef['isLoaded'] = false;
                    }

                    if (bodyItem.is_child === false) {
                        let newRef = '';
                        if (isObject(bodyItem)) {
                            newRef = `${bodyItem.tableName}.attributes.${bodyItem.name}.ezapi_object`;
                        } else if (isArray(bodyItem)) {
                            newRef = `${bodyItem.tableName}.attributes.${bodyItem.name}.ezapi_array.ezapi_object`;
                        }
                        clonedRef['ref'] = newRef;
                    }

                    return <BodySubTreeItems currentRef={clonedRef} projectType={projectType} />;
                })}

            {(isArrayOfObject(bodyItem) || (isObject(bodyItem) && bodyItem.properties)) &&
                arrayData.map((arrayItem) => {
                    let arrayItemRef;
                    if (isObject(bodyItem)) {
                        arrayItemRef = bodyItem.properties[arrayItem];
                    } else if (isArrayOfObject(bodyItem)) {
                        arrayItemRef = bodyItem.items?.properties[arrayItem];
                    }

                    if (isDatabase(arrayItemRef)) {
                        return (
                            <TreeItem
                                key={arrayItemRef?.payloadId ?? arrayItemRef?.name ?? treeIndex++}
                                nodeId={arrayItemRef?.payloadId ?? arrayItemRef?.name ?? treeIndex++}
                                label={
                                    isDatabase(arrayItemRef) ? (
                                        <DatabaseLabel
                                            tableLabelItem={arrayItemRef}
                                            deleteItem={() => deleteNestedItems(arrayItemRef, bodyItem)}
                                            array={bodyItem}
                                            isArrayChecked={isArrayChecked}
                                            request={request}
                                            responseCode={responseCode}
                                            isArrayOfObject
                                            onUpdate={(data) => {
                                                onUpdate(data);
                                                refresh();
                                            }}
                                        />
                                    ) : null
                                }
                                onLabelClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    onItemClick();
                                }}
                                onIconClick={(e) => {
                                    onItemClick();
                                }}
                            >
                                <div className="">
                                    {isDatabase(arrayItemRef) &&
                                        arrayItemRef?.selectedColumns?.map((ref) => {
                                            return (
                                                <ColumnLabel
                                                    columnLabelItem={ref}
                                                    request={request}
                                                    renameColumn={(column, name) =>
                                                        renameColumnOfTable(column, bodyItem, name, true, arrayItemRef)
                                                    }
                                                    isNameTaken={(column, value) => {
                                                        return isColumnNameTakenOfTable(
                                                            column,
                                                            bodyItem,
                                                            value,
                                                            true,
                                                            arrayItemRef,
                                                        );
                                                    }}
                                                    responseCode={responseCode}
                                                    deleteColumn={(column) =>
                                                        deleteColumnOfTable(column, bodyItem, true, arrayItemRef)
                                                    }
                                                />
                                            );
                                        })}
                                </div>
                            </TreeItem>
                        );
                    } else if (isColumn(arrayItemRef)) {
                        return (
                            <ColumnLabel
                                columnLabelItem={arrayItemRef}
                                deleteColumn={() => deleteNestedItems(arrayItemRef, bodyItem)}
                                array={bodyItem}
                                request={request}
                                responseCode={responseCode}
                                isArrayOfObject
                                onUpdate={(data) => {
                                    onUpdate(data);
                                    refresh();
                                }}
                            />
                        );
                    } else if (isAttribute(arrayItemRef)) {
                        return (
                            <AttributeLabel
                                labelItem={arrayItemRef}
                                deleteItem={() => deleteNestedItems(arrayItemRef, bodyItem)}
                                request={request}
                                responseCode={responseCode}
                                projectType={projectType}
                            />
                        );
                    } else if (isArrayOfObject(arrayItemRef) || isObject(arrayItemRef) || isArray(arrayItemRef)) {
                        if (isArray(arrayItemRef)) {
                            return (
                                <ArrayOrObjectLabel
                                    labelItem={arrayItemRef}
                                    isArrayChecked={isArrayChecked}
                                    deleteItem={() => {
                                        deleteNestedItems(arrayItemRef, bodyItem);
                                    }}
                                    request={request}
                                    responseCode={responseCode}
                                    projectType={projectType}
                                />
                            );
                        }
                        let arr = [];
                        if (isObject(arrayItemRef) && arrayItemRef.properties) {
                            arr = Object.keys(arrayItemRef.properties);
                        } else if (isArrayOfObject(arrayItemRef) && arrayItemRef.items?.properties) {
                            arr = Object.keys(arrayItemRef.items?.properties);
                        }

                        if (arrayItemRef) {
                            return (
                                <TreeItem
                                    key={
                                        arrayItemRef?.payloadId
                                            ? arrayItemRef?.payloadId + 'level3'
                                            : arrayItemRef?.name
                                            ? arrayItemRef?.name + 'level3'
                                            : treeIndex++ + 'level3'
                                    }
                                    nodeId={arrayItemRef?.payloadId ?? arrayItemRef?.name ?? treeIndex++}
                                    label={
                                        (isArrayOfObject(arrayItemRef) || isObject(arrayItemRef)) && (
                                            <ArrayOrObjectLabel
                                                labelItem={arrayItemRef}
                                                isArrayChecked={isArrayChecked}
                                                deleteItem={() => {
                                                    deleteNestedItems(arrayItemRef, bodyItem);
                                                }}
                                                request={request}
                                                responseCode={responseCode}
                                                projectType={projectType}
                                            />
                                        )
                                    }
                                    onLabelClick={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        onItemClick();
                                    }}
                                    onIconClick={(e) => {
                                        onItemClick();
                                    }}
                                >
                                    <div className="">
                                        {(isObject(arrayItemRef) || isArrayOfObject(arrayItemRef)) &&
                                            arr?.map((ref) => {
                                                let itemRef;
                                                if (isObject(arrayItemRef)) {
                                                    itemRef = arrayItemRef.properties[ref];
                                                } else {
                                                    itemRef = arrayItemRef.items?.properties[ref];
                                                }

                                                if (isColumn(itemRef)) {
                                                    return (
                                                        <ColumnLabel
                                                            columnLabelItem={itemRef}
                                                            deleteColumn={() => {
                                                                deleteItemsInsideNestedItems(
                                                                    itemRef,
                                                                    arrayItemRef,
                                                                    bodyItem,
                                                                );
                                                            }}
                                                            root={bodyItem}
                                                            array={arrayItemRef}
                                                            request={request}
                                                            responseCode={responseCode}
                                                            isArrayOfObject
                                                            onUpdate={(data) => {
                                                                onUpdate(data);
                                                                refresh();
                                                            }}
                                                        />
                                                    );
                                                } else if (isAttribute(itemRef)) {
                                                    return (
                                                        <AttributeLabel
                                                            labelItem={itemRef}
                                                            deleteItem={() => {
                                                                deleteItemsInsideNestedItems(
                                                                    itemRef,
                                                                    arrayItemRef,
                                                                    bodyItem,
                                                                );
                                                            }}
                                                            request={request}
                                                            responseCode={responseCode}
                                                            projectType={projectType}
                                                        />
                                                    );
                                                } else if (
                                                    isObject(itemRef) ||
                                                    isArray(itemRef) ||
                                                    isArrayOfObject(itemRef)
                                                ) {
                                                    return (
                                                        <ArrayOrObjectLabel
                                                            labelItem={itemRef}
                                                            // isArrayChecked={isArrayChecked}
                                                            deleteItem={() => {
                                                                deleteItemsInsideNestedItems(
                                                                    itemRef,
                                                                    arrayItemRef,
                                                                    bodyItem,
                                                                );
                                                            }}
                                                            styleClass="ml-6"
                                                            request={request}
                                                            responseCode={responseCode}
                                                            projectType={projectType}
                                                        />
                                                    );
                                                } else if (isDatabase(itemRef)) {
                                                    return (
                                                        <DatabaseLabel
                                                            tableLabelItem={itemRef}
                                                            deleteItem={() => {
                                                                deleteItemsInsideNestedItems(
                                                                    itemRef,
                                                                    arrayItemRef,
                                                                    bodyItem,
                                                                );
                                                            }}
                                                            root={bodyItem}
                                                            array={arrayItemRef}
                                                            // isArrayChecked={isArrayChecked}
                                                            request={request}
                                                            responseCode={responseCode}
                                                            isArrayOfObject
                                                            onUpdate={(data) => {
                                                                onUpdate(data);
                                                                refresh();
                                                            }}
                                                        />
                                                    );
                                                }
                                            })}
                                    </div>
                                </TreeItem>
                            );
                        }
                    }
                })}

            {isDatabase(bodyItem) &&
                bodyItem?.selectedColumns?.map((ref) => {
                    return (
                        <ColumnLabel
                            columnLabelItem={ref}
                            deleteColumn={(column) => deleteColumnOfTable(column, bodyItem)}
                            renameColumn={(column, name) => {
                                renameColumnOfTable(column, bodyItem, name);
                                refresh();
                            }}
                            request={request}
                            isNameTaken={(column, value) => {
                                return isColumnNameTakenOfTable(column, bodyItem, value);
                            }}
                            responseCode={responseCode}
                        />
                    );
                })}

            {bodyItem.inputAttributes &&
                isStoredProcedure(bodyItem) &&
                bodyItem?.inputAttributes?.map((ref) => {
                    return (
                        <InputOrOutputLabel
                            inputOrOutputLabelItem={ref}
                            // deleteColumn={(column) => deleteColumnOfTable(column, bodyItem)}
                            renameColumn={(column, name) => renameColumnOfTable(column, bodyItem, name)}
                            request={request}
                            isNameTaken={(column, value) => {
                                return isColumnNameTakenOfTable(column, bodyItem, value);
                            }}
                            responseCode={responseCode}
                        />
                    );
                })}
            {bodyItem.outputAttributes &&
                isStoredProcedure(bodyItem) &&
                bodyItem?.outputAttributes?.map((ref) => {
                    return (
                        <InputOrOutputLabel
                            inputOrOutputLabelItem={ref}
                            // deleteColumn={(column) => deleteColumnOfTable(column, bodyItem)}
                            renameColumn={(column, name) => renameColumnOfTable(column, bodyItem, name)}
                            request={request}
                            isNameTaken={(column, value) => {
                                return isColumnNameTakenOfTable(column, bodyItem, value);
                            }}
                            responseCode={responseCode}
                        />
                    );
                })}
        </TreeItem>
    );
};

// This is shown only for arrays, schemas, objects of a parent schema
const BodySubTreeItems = ({ currentRef: some, projectType }) => {
    const [currentRef, setCurrentRef] = useState(some);
    const { projectId } = useParams();
    const {
        isLoading: isLoadingSubSchema,
        error: getSubSchemasError,
        data: subSchemaData,
        mutate: getSubSchema,
        reset: resetSubSchemaData,
        variables: subSchemaRequest,
    } = useGetSubSchema();

    const {
        isLoading: isLoadingSubTable,
        error: getSubTablesError,
        data: subTableData,
        mutate: getSubTable,
        reset: resetSubTableData,
        isIdle: isGetSubTableIdle,
    } = useGetSubTables();

    const canEdit = useCanEdit();

    useEffect(() => {
        if (subSchemaData) {
            let itemsToConsider = [];

            if (subSchemaData?.nSchemaArray && !_.isEmpty(subSchemaData?.nSchemaArray)) {
                itemsToConsider = subSchemaData?.nSchemaArray;
            } else if (subSchemaData?.data && !_.isEmpty(subSchemaData?.data)) {
                itemsToConsider = subSchemaData?.data;
            }

            if (isSchema(currentRef) || isArray(currentRef) || isArrayOfObject(currentRef) || isObject(currentRef)) {
                currentRef.isLoaded = true;

                for (let index = 0; index < itemsToConsider.length; index++) {
                    const element = itemsToConsider[index];
                    currentRef.data.push(element);
                }
                const clonedClonedRef = _.cloneDeep(currentRef);

                setCurrentRef(clonedClonedRef);
            }
        }
    }, [subSchemaData]);

    useEffect(() => {
        if (subTableData) {
            let itemsToConsider = [];

            if (subTableData?.data && !_.isEmpty(subTableData?.data)) {
                itemsToConsider = subTableData?.data;
            }

            if (isSchema(currentRef) || isArray(currentRef) || isArrayOfObject(currentRef) || isObject(currentRef)) {
                currentRef.isLoaded = true;

                if (currentRef.data.length === 0) {
                    for (let index = 0; index < itemsToConsider.length; index++) {
                        const element = itemsToConsider[index];
                        currentRef.data.push(element);
                    }
                }
                const clonedClonedRef = _.cloneDeep(currentRef);

                setCurrentRef(clonedClonedRef);
            }
        }
    }, [subTableData]);

    const getSubschemaData = (subSchemaRef) => {
        if (subSchemaRef.is_child === false && projectType === 'db' && _.isEmpty(subSchemaRef.data)) {
            let newRef = '';

            if (isObject(subSchemaRef)) {
                newRef = `${subSchemaRef.ref}.${subSchemaRef.name}.ezapi_object`;
            } else if (isArray(subSchemaRef)) {
                newRef = `${subSchemaRef.ref}.${subSchemaRef.name}.ezapi_array.ezapi_object`;
            }

            getSubTable({
                projectId,
                name: subSchemaRef?.name,
                type: subSchemaRef?.type,
                ref: newRef,
            });
        }

        if (subSchemaRef.is_child === false) {
            if (
                !isLoadingSubSchema &&
                !subSchemaRef.isLoaded &&
                _.isEmpty(subSchemaRef.data) &&
                projectType === 'both'
            ) {
                getSubSchema({
                    projectId,
                    name: subSchemaRef?.name,
                    type: subSchemaRef?.type,
                    ref: subSchemaRef?.ref,
                });
            }
        }
    };

    return (
        <TreeItem
            key={currentRef?.payloadId ?? currentRef?.name ?? treeIndex++}
            nodeId={currentRef?.payloadId ?? currentRef?.name ?? treeIndex++}
            label={
                <div className="flex flex-row p-1 justify-between border-b-2">
                    <div className="flex flex-row items-center justify-center ">
                        <img
                            src={
                                isObject(currentRef)
                                    ? ObjectIcon
                                    : isArray(currentRef) && currentRef.is_child
                                    ? ArrayIcon2
                                    : isArray(currentRef) && !currentRef.is_child
                                    ? ArrayIcon
                                    : isAttribute(currentRef)
                                    ? AttributeIcon
                                    : SchemaIcon
                            }
                            alt="conektto logo"
                            className="bg-white mr-2"
                            style={{
                                height: '24px',
                                width: '24px',
                            }}
                        />

                        <div className="flex flex-row justify-between w-full items-center">
                            <p className="text-overline2 mr-4">
                                {currentRef?.schemaName ?? currentRef?.name}
                                {isArray(currentRef) && ' [ ]'}
                            </p>

                            {isLoadingSubSchema && subSchemaRequest.ref === currentRef?.ref && (
                                <CircularProgress
                                    style={{
                                        width: '1.25rem',
                                        height: '1.25rem',
                                    }}
                                />
                            )}
                        </div>
                    </div>
                </div>
            }
            onLabelClick={(e) => {
                e.preventDefault();
                e.stopPropagation();

                getSubschemaData(currentRef);
            }}
            onIconClick={(e) => {
                getSubschemaData(currentRef);
            }}
        >
            {currentRef.data.map((ref) => {
                if (isSchema(ref) || isArray(ref) || isObject(ref)) {
                    const clonedRef = _.cloneDeep(ref);

                    if (!clonedRef.hasOwnProperty('data')) {
                        clonedRef['data'] = [];
                    }

                    if (!clonedRef.hasOwnProperty('isLoaded')) {
                        clonedRef['isLoaded'] = false;
                    }
                    if (currentRef.is_child === false) {
                        let newRef = '';
                        if (isObject(currentRef)) {
                            newRef = `${currentRef.ref}.${currentRef.name}.ezapi_object`;
                        } else if (isArray(currentRef)) {
                            newRef = `${currentRef.ref}.${currentRef.name}.ezapi_array.ezapi_object`;
                        }
                        clonedRef['ref'] = newRef;
                    }
                    return <BodySubTreeItems currentRef={clonedRef} projectType={projectType} />;
                } else if (isAttribute(ref)) {
                    return (
                        <TreeItem
                            key={ref?.payloadId ?? ref?.name ?? treeIndex++}
                            nodeId={ref?.payloadId ?? ref?.name ?? treeIndex++}
                            label={
                                <div className="flex flex-row justify-between items-center p-1 border-b-2">
                                    <div className="flex flex-row items-center justify-start flex-1">
                                        <img
                                            src={AttributeIcon}
                                            alt="conektto logo"
                                            className="bg-white mr-2"
                                            style={{
                                                height: '24px',
                                                width: '24px',
                                            }}
                                        />

                                        <p className="text-overline2 ">{ref?.name} </p>
                                    </div>

                                    <div className="flex-1">
                                        <p>{ref?.type}</p>
                                    </div>

                                    <div className="flex-1">
                                        {/* <Checkbox
                      checked={ref?.required}
                      // checked={true}
                      style={{
                        color: Colors.brand.secondary,
                        padding: "0",
                      }}
                    /> */}
                                        {/* isRequired checkbox not needed */}
                                    </div>
                                </div>
                            }
                        />
                    );
                }
            })}
        </TreeItem>
    );
};
const ArrayOrObjectLabel = ({ styleClass, labelItem, request, isLoading, deleteItem, isArrayChecked, projectType }) => {
    const canEdit = useCanEdit();
    const [array, setIsArray] = useState(labelItem.isArray ?? false);

    return (
        <ReactHoverObserver>
            {({ isHovering }) => {
                return (
                    <div
                        className={
                            isArray(labelItem)
                                ? 'ml-6 flex flex-row p-1 h-8 justify-between items-center border-b-2'
                                : `flex flex-row p-1 justify-between items-center border-b-2 h-8 ${styleClass}`
                        }
                        style={isArray(labelItem) ? { paddingTop: '4px' } : null}
                    >
                        <div className="flex flex-row items-center justify-start w-full">
                            <div className="w-full grid grid-cols-5 gap-2 items-center">
                                <div className="flex justify-self-start items-center">
                                    {' '}
                                    <img
                                        src={
                                            isObject(labelItem)
                                                ? ObjectIcon
                                                : isArrayOfObject(labelItem)
                                                ? ArrayOfObjectsIcon
                                                : isArray(labelItem) && labelItem.is_child
                                                ? ArrayIcon2
                                                : ArrayIcon
                                        }
                                        alt="conektto logo"
                                        className="bg-white mr-4"
                                        style={{ height: '24px', width: '24px' }}
                                    />
                                    <p className="text-overline2">{labelItem?.name}</p>
                                </div>

                                {(projectType === 'db' || projectType === 'noinput') && (
                                    <div className="flex justify-self-start">{/* empty: no scheme attribute */}</div>
                                )}
                                <div className="flex  ml-1 justify-self-start">
                                    <p className="text-overline2">{labelItem?.type}</p>
                                </div>
                                <div className="flex  ml-1 justify-self-start"></div>
                                {isArray(labelItem) && (
                                    <div className="flex ml-3 justify-self-start">
                                        <Checkbox
                                            checked={array}
                                            onClick={(e) => {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                if (!labelItem.is_child && request) {
                                                    isArrayChecked(labelItem, !array, request);
                                                    setIsArray(!array);
                                                }
                                            }}
                                            style={{
                                                color: Colors.brand.secondary,
                                                padding: '0',
                                            }}
                                        />
                                    </div>
                                )}

                                <div> </div>
                                {isLoading && (
                                    <CircularProgress
                                        style={{
                                            marginLeft: '0.5rem',
                                            width: '20px',
                                            height: '20px',
                                        }}
                                    />
                                )}
                            </div>
                        </div>
                        <div className="w-6">
                            {' '}
                            {isHovering && canEdit() && (
                                <AppIcon
                                    onClick={(ev) => {
                                        ev?.preventDefault();
                                        ev?.stopPropagation();

                                        deleteItem(labelItem);
                                    }}
                                >
                                    <DeleteIcon />
                                </AppIcon>
                            )}
                        </div>
                    </div>
                );
            }}
        </ReactHoverObserver>
    );
};

/* const ArrayLabel = ({
  labelItem,
  request,
  isLoading,
  deleteItem,
  isArrayChecked,
}) => {
  const canEdit = useCanEdit();

  return (
    <ReactHoverObserver>
      {({ isHovering }) => {
        return (
          <div className="flex flex-row p-1 justify-between items-center border-b-2 h-8">
            <div className="flex flex-row items-center justify-start w-full">
              <div className="w-full grid grid-cols-5 gap-2 items-center">
                <div className="flex justify-self-start items-center">
                  {" "}
                  <img
                    src={ArrayIcon}
                    alt="conektto logo"
                    className="bg-white mr-4"
                    style={{ height: "24px", width: "24px" }}
                  />
                  <p className="text-overline2">{labelItem?.name}</p>
                </div>

                <div> </div>
                {isLoading && (
                  <CircularProgress
                    style={{
                      marginLeft: "0.5rem",
                      width: "20px",
                      height: "20px",
                    }}
                  />
                )}
              </div>
            </div>
            <div className="w-6">
              {" "}
              {isHovering && canEdit() && (
                <AppIcon
                  onClick={(ev) => {
                    ev?.preventDefault();
                    ev?.stopPropagation();

                    deleteItem(labelItem);
                  }}
                >
                  <DeleteIcon />
                </AppIcon>
              )}
            </div>
          </div>
        );
      }}
    </ReactHoverObserver>
  );
};
 */
const SchemaLabel = ({ labelItem, request, isLoading, deleteItem, isArrayChecked }) => {
    const canEdit = useCanEdit();
    //const [isArray, setIsArray] = useState(labelItem.isArray);

    return (
        <ReactHoverObserver>
            {({ isHovering }) => {
                return (
                    <div className="flex flex-row p-1 justify-between items-center border-b-2 h-8">
                        <div className="flex flex-row items-center justify-start w-full">
                            <div className="w-full grid grid-cols-5 gap-2 items-center">
                                <div className="flex justify-self-start items-center">
                                    {' '}
                                    <img
                                        src={SchemaIcon}
                                        alt="conektto logo"
                                        className="bg-white mr-4"
                                        style={{ height: '24px', width: '24px' }}
                                    />
                                    <p className="text-overline2">{labelItem?.schemaName ?? labelItem?.name}</p>
                                </div>
                                <div className="ml-1 flex justify-self-start">
                                    <p className="text-overline2">{labelItem?.type}</p>
                                </div>

                                <div> {/* empty datattype */}</div>
                                <div className="flex  ml-1 justify-self-start">
                                    {labelItem.hasOwnProperty('isArray') && (
                                        <Checkbox
                                            checked={labelItem?.isArray}
                                            disabled={true}
                                            style={{
                                                color: Colors.brand.secondary,
                                                padding: '0',
                                            }}
                                        />
                                    )}
                                </div>
                                <div> </div>
                                {isLoading && (
                                    <CircularProgress
                                        style={{
                                            marginLeft: '0.5rem',
                                            width: '20px',
                                            height: '20px',
                                        }}
                                    />
                                )}
                            </div>
                        </div>
                        <div className="w-6">
                            {' '}
                            {isHovering && canEdit() && (
                                <AppIcon
                                    onClick={(ev) => {
                                        ev?.preventDefault();
                                        ev?.stopPropagation();

                                        deleteItem(labelItem);
                                    }}
                                >
                                    <DeleteIcon />
                                </AppIcon>
                            )}
                        </div>
                    </div>
                );
            }}
        </ReactHoverObserver>
    );
};
//parameters
const AttributeLabel = ({ labelItem, deleteItem, projectType }) => {
    const canEdit = useCanEdit();
    const [openTooltip, setOpenTooltip] = useState(false);
    const [isHover, setIsHover] = React.useState([false, labelItem?.name]);
    function truncate(str, n) {
        return str.length > n ? str.substr(0, n - 1) + '...' : str;
    }
    function handleToolTipOpen() {
        if (isHover[0] && isHover[1] == labelItem?.name && labelItem?.name.length > truncateLength) {
            setOpenTooltip(true);
        } else {
            setOpenTooltip(false);
        }
    }
    return (
        <ReactHoverObserver>
            {({ isHovering }) => {
                return (
                    <div className="flex flex-row p-1 h-8 justify-between items-center border-b-2 ml-6 hover:bg-neutral-gray8">
                        <div className="flex flex-row items-center justify-start flex-1">
                            {(projectType === 'db' || projectType === 'noinput') && (
                                <div className=" w-full grid grid-cols-5 gap-2 items-center ">
                                    {' '}
                                    <div className="flex justify-self-start items-center">
                                        {labelItem?.id ? (
                                            <BlurCircularIcon
                                                className="bg-white mr-4"
                                                sx={{ height: '24px', width: '24px' }}
                                                color={'Primary'}
                                            />
                                        ) : (
                                            <img
                                                src={AttributeIcon}
                                                alt="conektto logo"
                                                className="bg-white mr-4"
                                                style={{ height: '24px', width: '24px' }}
                                            />
                                        )}
                                        <Tooltip
                                            title={labelItem?.name}
                                            open={openTooltip}
                                            onClose={handleToolTipOpen}
                                            onOpen={handleToolTipOpen}
                                            placement="left-start"
                                        >
                                            <p
                                                className="text-overline2"
                                                onMouseEnter={() => {
                                                    setIsHover([true, labelItem?.name]);
                                                }}
                                                onMouseLeave={() => {
                                                    setIsHover([false, labelItem?.name]);
                                                }}
                                            >
                                                {' '}
                                                {truncate(labelItem?.name, truncateLength)}{' '}
                                            </p>
                                        </Tooltip>
                                    </div>
                                    <div className="flex justify-self-start">{/* empty: no scheme attribute */}</div>
                                    <div className="ml-1 flex justify-self-start">
                                        <p className="text-overline2">{labelItem?.type}</p>
                                    </div>
                                    <div className="flex justify-self-start">{/* empty: no isarray Checkbox */}</div>
                                    <div className="flex ml-3 justify-self-start">
                                        <p className="text-overline2">
                                            <Checkbox
                                                checked={labelItem?.required}
                                                // checked={true}
                                                style={{
                                                    color: Colors.brand.secondary,
                                                    padding: '0',
                                                }}
                                            />
                                        </p>
                                    </div>
                                </div>
                            )}
                            {(projectType === 'schema' || projectType === 'both' || projectType === 'aggregate') && (
                                <div className=" w-full grid grid-cols-5 gap-2 items-center">
                                    {' '}
                                    <div className="flex justify-self-start items-center">
                                        {labelItem?.id ? (
                                            <BlurCircularIcon
                                                className="bg-white mr-4"
                                                sx={{ height: '24px', width: '24px' }}
                                                color={'Primary'}
                                            />
                                        ) : (
                                            <img
                                                src={AttributeIcon}
                                                alt="conektto logo"
                                                className="bg-white mr-4"
                                                style={{ height: '24px', width: '24px' }}
                                            />
                                        )}
                                        <Tooltip
                                            title={labelItem?.name}
                                            open={openTooltip}
                                            onClose={handleToolTipOpen}
                                            onOpen={handleToolTipOpen}
                                            placement="left-start"
                                        >
                                            <p
                                                onMouseEnter={() => {
                                                    setIsHover([true, labelItem?.name]);
                                                }}
                                                onMouseLeave={() => {
                                                    setIsHover([false, labelItem?.name]);
                                                }}
                                                className="text-overline2"
                                            >
                                                {truncate(labelItem?.name, truncateLength)}
                                            </p>
                                        </Tooltip>{' '}
                                    </div>
                                    <div className="ml-1 flex justify-self-start">
                                        <p className="text-overline2">{labelItem?.type}</p>
                                    </div>
                                    <div className="flex justify-self-start">{/* empty: no isarray Checkbox */}</div>
                                    <div className="flex ml-3 justify-self-start">
                                        {/* <p className='text-overline2'>
                        <Checkbox
                          checked={labelItem?.required}
                          // checked={true}
                          style={{
                            color: Colors.brand.secondary,
                            padding: "0",
                          }}
                        />
                      </p> */}
                                        {/* isRequired not needed for now */}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="w-6">
                            {isHovering && canEdit() && (
                                <AppIcon
                                    onClick={(ev) => {
                                        ev?.preventDefault();
                                        ev?.stopPropagation();

                                        deleteItem(labelItem);
                                    }}
                                >
                                    <DeleteIcon />
                                </AppIcon>
                            )}
                        </div>
                    </div>
                );
            }}
        </ReactHoverObserver>
    );
};
//drag and drop tables
const DatabaseLabel = ({
    tableLabelItem,
    request,
    responseCode,
    deleteItem,
    isArrayChecked,
    isArrayOfObject = false,
    array,

    root,
    onUpdate = () => {},
}) => {
    const [optionsMenuAnchorEl, setOptionsMenuAnchorEl] = useState(false);
    const [isArray, setIsArray] = useState(tableLabelItem.isArray);
    const [openTooltip, setOpenTooltip] = useState(false);
    const [isHover, setIsHover] = React.useState([false, tableLabelItem?.sourceName]);
    const [dialog, setDialog] = useState({
        show: false,
        type: null,
        data: null,
    });
    const nameRef = useRef();
    const canEdit = useCanEdit();

    //const setOperationDetails = useSetRecoilState(operationAtomWithMiddleware);

    useDoubleClick({
        onSingleClick: (e) => {},
        onDoubleClick: (e) => {
            e?.preventDefault();
            e?.stopPropagation();

            if (canEdit()) {
                showTableNameChangeDialog();
            }
        },
        ref: nameRef,
        latency: 275,
    });

    const showTableNameChangeDialog = () => {
        if (canEdit()) {
            setDialog({
                show: true,
                type: 'rename-table',
            });
        }
    };

    const handleOptionsClick = (event) => {
        setOptionsMenuAnchorEl(event?.currentTarget);
    };

    const handleCloseDialog = () => {
        setDialog({
            show: false,
            data: null,
        });
    };
    function truncate(str, n) {
        return str.length > n ? str.substr(0, n - 1) + '...' : str;
    }
    function handleToolTipOpen() {
        if (
            isHover[0] &&
            isHover[1] == tableLabelItem?.sourceName &&
            tableLabelItem?.sourceName.length > truncateLength
        ) {
            setOpenTooltip(true);
        } else {
            setOpenTooltip(false);
        }
    }
    return (
        <ReactHoverObserver>
            {({ isHovering }) => {
                return (
                    <>
                        <Dialog
                            aria-labelledby="dashboard-dialog"
                            open={dialog?.show ?? false}
                            fullWidth
                            PaperProps={{
                                style: { borderRadius: 8 },
                            }}
                            onClose={(event, reason) => {
                                if (reason !== 'backdropClick') {
                                    handleCloseDialog();
                                }
                            }}
                        >
                            {dialog?.type === 'rename-table' && canEdit() && !isArrayOfObject && (
                                <ChangeTableName
                                    labelItem={tableLabelItem}
                                    request={request}
                                    responseCode={responseCode}
                                    onClose={handleCloseDialog}
                                    onUpdate={(data) => {
                                        onUpdate(data);
                                    }}
                                />
                            )}
                            {dialog?.type === 'rename-table' && canEdit() && isArrayOfObject && root === undefined && (
                                <ChangeNameInsideArray
                                    labelItem={tableLabelItem}
                                    request={request}
                                    responseCode={responseCode}
                                    onClose={handleCloseDialog}
                                    array={array}
                                    onUpdate={(data) => {
                                        onUpdate(data);
                                    }}
                                />
                            )}
                            {dialog?.type === 'rename-table' && canEdit() && isArrayOfObject && root && (
                                <ChangeNameInsideArray
                                    root={root}
                                    labelItem={tableLabelItem}
                                    request={request}
                                    responseCode={responseCode}
                                    onClose={handleCloseDialog}
                                    array={array}
                                    onUpdate={(data) => {
                                        onUpdate(data);
                                    }}
                                />
                            )}
                        </Dialog>

                        <div className="flex flex-row p-1 justify-between items-center border-b-2 h-8">
                            <div className="flex flex-row items-center justify-start w-full ">
                                <div className="w-full grid grid-cols-5 gap-2 items-center ">
                                    {' '}
                                    <div className="flex justify-self-start items-center">
                                        <img
                                            src={TableIcon}
                                            alt="conektto logo"
                                            className="bg-white mr-4"
                                            style={{ height: '24px', width: '24px' }}
                                        />
                                        {tableLabelItem?.sourceName && !_.isEmpty(tableLabelItem?.sourceName) ? (
                                            <Tooltip
                                                title={tableLabelItem?.sourceName}
                                                open={openTooltip}
                                                onClose={handleToolTipOpen}
                                                onOpen={handleToolTipOpen}
                                                placement="left-start"
                                            >
                                                <p
                                                    id="tableNameTruncate"
                                                    onMouseEnter={() => {
                                                        setIsHover([true, tableLabelItem?.sourceName]);
                                                    }}
                                                    onMouseLeave={() => {
                                                        setIsHover([false, tableLabelItem?.sourceName]);
                                                    }}
                                                    className="text-overline2"
                                                >
                                                    {truncate(tableLabelItem?.sourceName, truncateLength)}
                                                </p>
                                            </Tooltip>
                                        ) : null}
                                    </div>
                                    <div className="flex -ml-4 justify-self-start">
                                        {' '}
                                        {tableLabelItem?.name && !_.isEmpty(tableLabelItem?.name) ? (
                                            <p className="text-overline2 ml-4 select-none" ref={nameRef}>
                                                {tableLabelItem?.name}
                                            </p>
                                        ) : null}
                                    </div>
                                    <div> {/* empty datattype */}</div>
                                    <div className="flex  ml-1 justify-self-start">
                                        <Checkbox
                                            checked={isArray}
                                            onClick={(e) => {
                                                e.preventDefault();
                                                e.stopPropagation();

                                                isArrayChecked(tableLabelItem, !isArray, request);
                                                setIsArray(!isArray);
                                            }}
                                            style={{
                                                color: Colors.brand.secondary,
                                                padding: '0',
                                            }}
                                        />
                                    </div>
                                    <div>{/* empty required */}</div>
                                </div>
                            </div>

                            <div className="w-6">
                                {isHovering && canEdit() && (
                                    <>
                                        <AppIcon
                                            onClick={(ev) => {
                                                ev?.preventDefault();
                                                ev?.stopPropagation();

                                                handleOptionsClick(ev);
                                            }}
                                        >
                                            <MoreVertIcon style={{ fontSize: '24px' }} />
                                        </AppIcon>

                                        <Menu
                                            id="table-menu"
                                            anchorEl={optionsMenuAnchorEl}
                                            keepMounted
                                            open={Boolean(optionsMenuAnchorEl)}
                                            onClose={() => {
                                                setOptionsMenuAnchorEl(null);
                                            }}
                                            TransitionComponent={Fade}
                                            style={{ borderRadius: '1rem', zIndex: '100' }}
                                        >
                                            <MenuItem
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    setOptionsMenuAnchorEl(null);

                                                    showTableNameChangeDialog();
                                                }}
                                            >
                                                <p className="text-overline2">Rename</p>
                                            </MenuItem>
                                            <MenuItem
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    setOptionsMenuAnchorEl(null);

                                                    deleteItem(tableLabelItem);
                                                }}
                                            >
                                                <p className="text-overline2 text-accent-red">Delete</p>
                                            </MenuItem>
                                        </Menu>
                                    </>
                                )}
                            </div>
                        </div>
                    </>
                );
            }}
        </ReactHoverObserver>
    );
};
//attributes && columns within a table
const ColumnLabel = ({
    columnLabelItem,
    request,
    responseCode,
    deleteColumn,
    renameColumn,
    isNameTaken,
    isDeletable = true,
    isArrayOfObject = false,
    array,
    isPartOfTable = true,
    root,
    onUpdate = () => {},
}) => {
    let [operationData, setOperationDetails] = useRecoilState(operationAtomWithMiddleware);
    const [openTooltip, setOpenTooltip] = useState(false);
    const [isHover, setIsHover] = React.useState([false, columnLabelItem?.sourceNames]);
    if (
        columnLabelItem.auto == true &&
        request == true &&
        operationData?.operation?.operationType?.toLowerCase() === 'post'
    ) {
        deleteColumn(columnLabelItem);
    }

    const [optionsMenuAnchorEl, setOptionsMenuAnchorEl] = useState(false);
    const [dialog, setDialog] = useState({
        show: false,
        type: null,
        data: null,
    });
    const nameRef = useRef();
    const canEdit = useCanEdit();

    useDoubleClick({
        onSingleClick: (e) => {},
        onDoubleClick: (e) => {
            e?.preventDefault();
            e?.stopPropagation();

            if (canEdit()) {
                showColumnNameChangeDialog();
            }
        },
        ref: nameRef,
        latency: 275,
    });

    const showColumnNameChangeDialog = () => {
        if (canEdit()) {
            setDialog({
                show: true,
                type: 'rename-column',
            });
        }
    };

    const handleOptionsClick = (event) => {
        setOptionsMenuAnchorEl(event?.currentTarget);
    };

    const handleCloseDialog = () => {
        setDialog({
            show: false,
            data: null,
        });
    };
    function truncate(str, n) {
        return str.length > n ? str.substr(0, n - 1) + '...' : str;
    }
    function handleToolTipOpen() {
        if (
            isHover[0] &&
            isHover[1] == columnLabelItem?.sourceName &&
            columnLabelItem?.sourceName.length > truncateLength
        ) {
            setOpenTooltip(true);
        } else {
            setOpenTooltip(false);
        }
    }
    return (
        <ReactHoverObserver>
            {({ isHovering }) => {
                return (
                    <>
                        <Dialog
                            aria-labelledby="column-dialog"
                            open={dialog?.show ?? false}
                            fullWidth
                            PaperProps={{
                                style: { borderRadius: 8 },
                            }}
                            onClose={(event, reason) => {
                                if (reason !== 'backdropClick') {
                                    handleCloseDialog();
                                }
                            }}
                        >
                            {dialog?.type === 'rename-column' && canEdit() && !isArrayOfObject && (
                                <ChangeColumnName
                                    labelItem={columnLabelItem}
                                    request={request}
                                    responseCode={responseCode}
                                    renameColumn={(column, value) => {
                                        renameColumn(column, value);

                                        handleCloseDialog();
                                    }}
                                    isNameTaken={isNameTaken}
                                    onClose={handleCloseDialog}
                                />
                            )}
                            {dialog?.type === 'rename-column' && canEdit() && root === undefined && isArrayOfObject && (
                                <ChangeNameInsideArray
                                    labelItem={columnLabelItem}
                                    request={request}
                                    responseCode={responseCode}
                                    onClose={handleCloseDialog}
                                    array={array}
                                    isColumn
                                    onUpdate={(data) => {
                                        onUpdate(data);
                                    }}
                                />
                            )}

                            {dialog?.type === 'rename-column' && canEdit() && root && isArrayOfObject && (
                                <ChangeNameInsideArray
                                    root={root}
                                    labelItem={columnLabelItem}
                                    request={request}
                                    responseCode={responseCode}
                                    onClose={handleCloseDialog}
                                    array={array}
                                    isColumn
                                    onUpdate={(data) => {
                                        onUpdate(data);
                                    }}
                                />
                            )}
                        </Dialog>{' '}
                        <div className=" flex flex-row p-1 h-8 justify-between items-center border-b-2 ml-6 hover:bg-neutral-gray8">
                            <div className="flex flex-row items-center justify-start flex-1">
                                <div className=" w-full grid grid-cols-5 gap-2 items-center ">
                                    {' '}
                                    <div className="flex justify-self-start items-center ">
                                        {isPartOfTable && (
                                            <AppIcon className="mr-1 opacity-50">
                                                <DragIndicatorIcon
                                                    className={classNames({
                                                        'cursor-move': canEdit(),
                                                    })}
                                                    style={{ height: '24px', width: '24px' }}
                                                />
                                            </AppIcon>
                                        )}
                                        <img
                                            src={ColumnIcon}
                                            alt="conektto logo"
                                            className="bg-white mr-4"
                                            style={{ height: '24px', width: '24px' }}
                                        />
                                        <Tooltip
                                            title={columnLabelItem?.sourceName}
                                            open={openTooltip}
                                            onClose={handleToolTipOpen}
                                            onOpen={handleToolTipOpen}
                                            placement="left-start"
                                        >
                                            <p
                                                className="text-overline2"
                                                onMouseEnter={() => {
                                                    setIsHover([true, columnLabelItem?.sourceName]);
                                                }}
                                                onMouseLeave={() => {
                                                    setIsHover([false, columnLabelItem?.sourceName]);
                                                }}
                                            >
                                                {truncate(columnLabelItem?.sourceName, truncateLength)}
                                            </p>
                                        </Tooltip>
                                    </div>
                                    <div className="flex justify-self-start  cursor-pointer select-none" ref={nameRef}>
                                        <p className="text-overline2">{columnLabelItem?.name}</p>
                                    </div>
                                    <div className="flex ml-1 justify-self-start">
                                        <p className="text-overline2">{columnLabelItem?.type}</p>
                                    </div>
                                    <div className="flex justify-self-start">{/* empty: no isarray Checkbox */}</div>
                                    <div className="flex ml-3 justify-self-start">
                                        <p className="text-overline2">
                                            <Checkbox
                                                checked={columnLabelItem?.required}
                                                style={{
                                                    color: Colors.brand.secondary,
                                                    padding: '0',
                                                }}
                                            />
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div className="w-6">
                                {isHovering && canEdit() && isDeletable && (
                                    <>
                                        <AppIcon
                                            onClick={(ev) => {
                                                ev?.preventDefault();
                                                ev?.stopPropagation();

                                                handleOptionsClick(ev);
                                            }}
                                        >
                                            <MoreVertIcon />
                                        </AppIcon>

                                        <Menu
                                            id="table-menu"
                                            anchorEl={optionsMenuAnchorEl}
                                            keepMounted
                                            open={Boolean(optionsMenuAnchorEl)}
                                            onClose={() => {
                                                setOptionsMenuAnchorEl(null);
                                            }}
                                            TransitionComponent={Fade}
                                            style={{ borderRadius: '1rem', zIndex: '100' }}
                                        >
                                            <MenuItem
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    setOptionsMenuAnchorEl(null);

                                                    showColumnNameChangeDialog();
                                                }}
                                            >
                                                <p className="text-overline2">Rename</p>
                                            </MenuItem>
                                            {isDeletable && (
                                                <MenuItem
                                                    onClick={(e) => {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        setOptionsMenuAnchorEl(null);

                                                        deleteColumn(columnLabelItem);
                                                    }}
                                                >
                                                    <p className="text-overline2 text-accent-red">Delete</p>
                                                </MenuItem>
                                            )}
                                        </Menu>
                                    </>
                                )}
                            </div>
                        </div>
                    </>
                );
            }}
        </ReactHoverObserver>
    );
};

const StoredProcedureLabel = ({
    storedProcedureLabelItem,
    request,
    responseCode,
    deleteItem,
    isArrayChecked,
    onUpdate = () => {},
}) => {
    const [optionsMenuAnchorEl, setOptionsMenuAnchorEl] = useState(false);
    const [isArray, setIsArray] = useState(storedProcedureLabelItem.isArray);
    const [openTooltip, setOpenTooltip] = useState(false);
    const [isHover, setIsHover] = React.useState([false, storedProcedureLabelItem?.sourceName]);
    const [dialog, setDialog] = useState({
        show: false,
        type: null,
        data: null,
    });
    const nameRef = useRef();
    const canEdit = useCanEdit();

    const setOperationDetails = useSetRecoilState(operationAtomWithMiddleware);

    // useDoubleClick({
    //   onSingleClick: (e) => {},
    //   onDoubleClick: (e) => {
    //     e?.preventDefault();
    //     e?.stopPropagation();

    //     if (canEdit()) {
    //       showTableNameChangeDialog();
    //     }
    //   },
    //   ref: nameRef,
    //   latency: 275,
    // });

    const showTableNameChangeDialog = () => {
        if (canEdit()) {
            setDialog({
                show: true,
                type: 'rename-table',
            });
        }
    };

    const handleOptionsClick = (event) => {
        setOptionsMenuAnchorEl(event?.currentTarget);
    };

    const handleCloseDialog = () => {
        setDialog({
            show: false,
            data: null,
        });
    };
    function truncate(str, n) {
        return str.length > n ? str.substr(0, n - 1) + '...' : str;
    }
    function handleToolTipOpen() {
        if (
            isHover[0] &&
            isHover[1] == storedProcedureLabelItem?.name &&
            storedProcedureLabelItem?.name.length > truncateLength
        ) {
            setOpenTooltip(true);
        } else {
            setOpenTooltip(false);
        }
    }

    return (
        <ReactHoverObserver>
            {({ isHovering }) => {
                return (
                    <>
                        <Dialog
                            aria-labelledby="dashboard-dialog"
                            open={dialog?.show ?? false}
                            fullWidth
                            PaperProps={{
                                style: { borderRadius: 8 },
                            }}
                            onClose={(event, reason) => {
                                if (reason !== 'backdropClick') {
                                    handleCloseDialog();
                                }
                            }}
                        >
                            {dialog?.type === 'rename-table' && canEdit() && (
                                <ChangeTableName
                                    labelItem={storedProcedureLabelItem}
                                    request={request}
                                    responseCode={responseCode}
                                    onClose={handleCloseDialog}
                                    onUpdate={(data) => {
                                        onUpdate(data);
                                    }}
                                />
                            )}
                        </Dialog>

                        <div className="flex flex-row p-1 justify-between items-center border-b-2 h-8">
                            <div className="flex flex-row items-center justify-start w-full ">
                                <div className="w-full grid grid-cols-5 gap-2 items-center ">
                                    {' '}
                                    <div className="flex justify-self-start items-center">
                                        <img
                                            src={StoredProcedureIcon}
                                            alt="conektto logo"
                                            className="bg-white mr-4"
                                            style={{ height: '24px', width: '24px' }}
                                        />
                                        {storedProcedureLabelItem?.name &&
                                        !_.isEmpty(storedProcedureLabelItem?.name) ? (
                                            <Tooltip
                                                title={storedProcedureLabelItem?.name}
                                                open={openTooltip}
                                                onClose={handleToolTipOpen}
                                                onOpen={handleToolTipOpen}
                                                placement="left-start"
                                            >
                                                <p
                                                    id="tableNameTruncate"
                                                    onMouseEnter={() => {
                                                        setIsHover([true, storedProcedureLabelItem?.sourceName]);
                                                    }}
                                                    onMouseLeave={() => {
                                                        setIsHover([false, storedProcedureLabelItem?.sourceName]);
                                                    }}
                                                    className="text-overline2"
                                                >
                                                    {truncate(storedProcedureLabelItem?.name, truncateLength)}
                                                </p>
                                            </Tooltip>
                                        ) : null}
                                    </div>
                                    <div> {/* empty schema/attribute */}</div>
                                    <div> {/* empty datattype */}</div>
                                    <div> {/* empty Isarray */}</div>
                                    <div>{/* empty required */}</div>
                                </div>
                            </div>

                            <div className="w-6">
                                {isHovering && canEdit() && (
                                    <>
                                        <AppIcon
                                            onClick={(ev) => {
                                                ev?.preventDefault();
                                                ev?.stopPropagation();

                                                handleOptionsClick(ev);
                                            }}
                                        >
                                            <MoreVertIcon style={{ fontSize: '24px' }} />
                                        </AppIcon>

                                        <Menu
                                            id="table-menu"
                                            anchorEl={optionsMenuAnchorEl}
                                            keepMounted
                                            open={Boolean(optionsMenuAnchorEl)}
                                            onClose={() => {
                                                setOptionsMenuAnchorEl(null);
                                            }}
                                            TransitionComponent={Fade}
                                            style={{ borderRadius: '1rem', zIndex: '100' }}
                                        >
                                            <MenuItem
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    setOptionsMenuAnchorEl(null);

                                                    showTableNameChangeDialog();
                                                }}
                                            >
                                                <p className="text-overline2">Rename</p>
                                            </MenuItem>
                                            <MenuItem
                                                onClick={(e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    setOptionsMenuAnchorEl(null);

                                                    deleteItem(storedProcedureLabelItem);
                                                }}
                                            >
                                                <p className="text-overline2 text-accent-red">Delete</p>
                                            </MenuItem>
                                        </Menu>
                                    </>
                                )}
                            </div>
                        </div>
                    </>
                );
            }}
        </ReactHoverObserver>
    );
};

const InputOrOutputLabel = ({
    inputOrOutputLabelItem,
    request,
    responseCode,
    // deleteColumn,
    renameColumn,
    isNameTaken,
}) => {
    /*let [operationData, setOperationDetails] = useRecoilState(
    operationAtomWithMiddleware
  );*/
    const [openTooltip, setOpenTooltip] = useState(false);
    const [isHover, setIsHover] = React.useState([false, inputOrOutputLabelItem?.sourceNames]);

    //const [optionsMenuAnchorEl, setOptionsMenuAnchorEl] = useState(false);
    const [dialog, setDialog] = useState({
        show: false,
        type: null,
        data: null,
    });
    const nameRef = useRef();
    const canEdit = useCanEdit();

    useDoubleClick({
        onSingleClick: (e) => {},
        onDoubleClick: (e) => {
            e?.preventDefault();
            e?.stopPropagation();

            if (canEdit()) {
                showColumnNameChangeDialog();
            }
        },
        ref: nameRef,
        latency: 275,
    });

    const showColumnNameChangeDialog = () => {
        if (canEdit()) {
            setDialog({
                show: true,
                type: 'rename-column',
            });
        }
    };

    /*const handleOptionsClick = (event) => {
    setOptionsMenuAnchorEl(event?.currentTarget);
  };

  const handleCloseDialog = () => {
    setDialog({
      show: false,
      data: null,
    });
  };*/
    function truncate(str, n) {
        return str.length > n ? str.substr(0, n - 1) + '...' : str;
    }
    function handleToolTipOpen() {
        if (
            isHover[0] &&
            isHover[1] == inputOrOutputLabelItem?.name &&
            inputOrOutputLabelItem?.name.length > truncateLength
        ) {
            setOpenTooltip(true);
        } else {
            setOpenTooltip(false);
        }
    }
    return (
        <ReactHoverObserver>
            {({ isHovering }) => {
                return (
                    <>
                        {/* <Dialog
              onClose={handleCloseDialog}
              aria-labelledby='column-dialog'
              open={dialog?.show ?? false}
              fullWidth
              PaperProps={{
                style: { borderRadius: 8 },
              }}
              disableBackdropClick
            >
              {dialog?.type === "rename-column" && canEdit() && (
                <ChangeColumnName
                  labelItem={inputOrOutputLabelItem}
                  request={request}
                  responseCode={responseCode}
                  renameColumn={(column, value) => {
                    renameColumn(column, value);

                    handleCloseDialog();
                  }}
                  isNameTaken={isNameTaken}
                  onClose={handleCloseDialog}
                />
              )}
            </Dialog> */}

                        <div className=" flex flex-row p-1 h-8 justify-between items-center border-b-2 ml-6 hover:bg-neutral-gray8">
                            <div className="flex flex-row items-center justify-start flex-1">
                                <div className=" w-full grid grid-cols-5 gap-2 items-center ">
                                    {' '}
                                    <div className="flex justify-self-start items-center ">
                                        <img
                                            src={
                                                inputOrOutputLabelItem.type === 'input'
                                                    ? InputIcon
                                                    : inputOrOutputLabelItem.type === 'output'
                                                    ? OutputIcon
                                                    : null
                                            }
                                            alt="conektto logo"
                                            className="bg-white mr-4"
                                            style={{ height: '24px', width: '24px' }}
                                        />
                                        <Tooltip
                                            title={inputOrOutputLabelItem?.name}
                                            open={openTooltip}
                                            onClose={handleToolTipOpen}
                                            onOpen={handleToolTipOpen}
                                            placement="left-start"
                                        >
                                            <p
                                                className="text-overline2"
                                                onMouseEnter={() => {
                                                    setIsHover([true, inputOrOutputLabelItem?.name]);
                                                }}
                                                onMouseLeave={() => {
                                                    setIsHover([false, inputOrOutputLabelItem?.name]);
                                                }}
                                            >
                                                {truncate(inputOrOutputLabelItem?.name, truncateLength)}
                                            </p>
                                        </Tooltip>
                                    </div>
                                    <div className="flex justify-self-start  cursor-pointer select-none" ref={nameRef}>
                                        {/* <p className='text-overline2'>
                      {inputOrOutputLabelItem?.name}
                    </p> */}
                                    </div>
                                    <div className="flex ml-1 justify-self-start">
                                        <p className="text-overline2">{/* {inputOrOutputLabelItem?.type} */}</p>
                                    </div>
                                    <div className="flex justify-self-start">{/* empty: no isarray Checkbox */}</div>
                                    <div className="flex ml-3 justify-self-start">
                                        {/* empty: no isarray Checkbox */}
                                    </div>
                                </div>
                            </div>

                            {/* <div className='w-6'>
                {isHovering && canEdit() && (
                  <>
                    <AppIcon
                      onClick={(ev) => {
                        ev?.preventDefault();
                        ev?.stopPropagation();

                        handleOptionsClick(ev);
                      }}
                    >
                      <MoreVertIcon />
                    </AppIcon>

                    <Menu
                      id='table-menu'
                      anchorEl={optionsMenuAnchorEl}
                      keepMounted
                      open={Boolean(optionsMenuAnchorEl)}
                      onClose={() => {
                        setOptionsMenuAnchorEl(null);
                      }}
                      TransitionComponent={Fade}
                      style={{ borderRadius: "1rem", zIndex: "100" }}
                    >
                      <MenuItem
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          setOptionsMenuAnchorEl(null);

                          showColumnNameChangeDialog();
                        }}
                      >
                        <p className='text-overline2'>Rename</p>
                      </MenuItem>
                      <MenuItem
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          setOptionsMenuAnchorEl(null);

                          deleteColumn(inputOrOutputLabelItem);
                        }}
                      >
                        <p className='text-overline2 text-accent-red'>Delete</p>
                      </MenuItem>
                    </Menu>
                  </>
                )}
              </div> */}
                        </div>
                    </>
                );
            }}
        </ReactHoverObserver>
    );
};

export default Body;
