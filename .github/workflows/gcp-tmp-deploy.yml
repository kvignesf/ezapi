name: EZAPI GCP Temp Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # 1. Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Build React UI
      - name: Build React UI
        working-directory: ezapi-ui
        env:
          HUSKY: 0
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_AES_ENCRYPTION_KEY: ${{ secrets.REACT_APP_AES_ENCRYPTION_KEY }}
          REACT_APP_LINKEDIN_CLIENT_ID: ${{ secrets.REACT_APP_LINKEDIN_CLIENT_ID }}
          REACT_APP_STRIPE_KEY: ${{ secrets.REACT_APP_STRIPE_KEY }}
        run: |
          cat > .env << EOF
          REACT_APP_API_URL=$REACT_APP_API_URL
          REACT_APP_AES_ENCRYPTION_KEY=$REACT_APP_AES_ENCRYPTION_KEY
          REACT_APP_LINKEDIN_CLIENT_ID=$REACT_APP_LINKEDIN_CLIENT_ID
          REACT_APP_STRIPE_KEY=$REACT_APP_STRIPE_KEY
          EOF
          npm install
          npm run build

      # 3. Build Java Codegen
      - name: Build Java Codegen
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Build Java JAR
        working-directory: ezapi-codegen
        run: mvn -B clean package -DskipTests

      # 4. Build Python Miner
      - name: Build Python Miner
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Core Python Dependencies
        working-directory: ezapi-miner
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          sudo apt-get update
          pip install flask==2.3.3 flask-cors==4.0.0 requests==2.31.0 
          pip install numpy==1.24.3 pandas==2.0.3 sqlalchemy==2.0.23
          pip install pymongo==4.6.1 psycopg2-binary==2.9.7 pyjwt==2.8.0 python-decouple==3.8
          pip install importlib-metadata==4.8.3 blinker>=1.6.0
          pip freeze > requirements.txt
          zip -r ../python-app.zip . -x "*.git*" "venv/*" "__pycache__/*" "*.log" "test*"

      # 5. Build Node.js Backend - WITH ALL FIXES
      - name: Build Node.js Backend
        working-directory: ezapi-backend
        run: |
          # Apply critical fixes during build
          cat > apply_fixes.js << 'FIXES_EOF'
          const fs = require('fs');
          
          // Fix 1: Make OpenAI initialization safe
          const chatFile = 'src/utility/chatCompletions.js';
          if (fs.existsSync(chatFile)) {
            const safeOpenAICode = `const { OpenAI } = require('openai');
            
            let openai = null;
            let openaiInitialized = false;
            
            if (process.env.OPENAI_API_KEY && 
                process.env.OPENAI_API_KEY !== 'your-key-here' && 
                process.env.OPENAI_API_KEY.length > 20) {
              try {
                openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
                openaiInitialized = true;
                console.log('âœ“ OpenAI initialized successfully');
              } catch (error) {
                console.warn('âš ï¸ OpenAI initialization failed:', error.message);
              }
            } else {
              console.warn('âš ï¸ OpenAI not initialized - API key missing or invalid');
            }
            
            const generateCodeUsingPrompt = async (prompt) => {
              if (!openaiInitialized || !openai) {
                throw new Error('OpenAI API key not configured. Please set OPENAI_API_KEY environment variable.');
              }
              try {
                const completion = await openai.chat.completions.create({
                  model: "gpt-3.5-turbo",
                  messages: [{ role: "user", content: prompt }],
                });
                return completion.choices[0].message.content;
              } catch (error) {
                console.error('OpenAI API error:', error);
                throw error;
              }
            };
            
            module.exports = { generateCodeUsingPrompt };`;
            
            fs.writeFileSync(chatFile, safeOpenAICode);
            console.log('âœ“ Fixed OpenAI initialization');
          }
          
          // Fix 2: Make WorkOS initialization safe
          const authFile = 'src/routes/auth.js';
          if (fs.existsSync(authFile)) {
            let authContent = fs.readFileSync(authFile, 'utf8');
            if (authContent.includes('new WorkOS(')) {
              authContent = authContent.replace(
                /const workos = new WorkOS\(.*\);/,
                \`let workos = null;
                if (process.env.WORKOS_API_KEY && process.env.WORKOS_API_KEY !== 'your_workos_key') {
                  workos = new WorkOS(process.env.WORKOS_API_KEY);
                  console.log('âœ“ WorkOS initialized successfully');
                } else {
                  console.warn('âš ï¸ WorkOS not initialized - API key missing or invalid');
                }\`
              );
              fs.writeFileSync(authFile, authContent);
              console.log('âœ“ Fixed WorkOS initialization');
            }
          }
          
          // Fix 3: Fix aiServerURL usage in projects.js
          const projectsFile = 'src/routes/projects.js';
          if (fs.existsSync(projectsFile)) {
            let projectsContent = fs.readFileSync(projectsFile, 'utf8');
            if (projectsContent.includes("let hostPath = aiServerURL.replace(':5000', '');")) {
              projectsContent = projectsContent.replace(
                "let hostPath = aiServerURL.replace(':5000', '');",
                "let hostPath = aiServerURL ? aiServerURL.replace(':5000', '') : 'http://localhost:5000';"
              );
              fs.writeFileSync(projectsFile, projectsContent);
              console.log('âœ“ Fixed aiServerURL usage');
            }
          }
          
          // Fix 4: Update MongoDB connection
          const dbFile = 'src/db/mongoose.js';
          if (fs.existsSync(dbFile)) {
            const resilientDbCode = \`const mongoose = require('mongoose');
            
            const dbConnect = async () => {
              try {
                const conn = await mongoose.connect(process.env.MONGO_CONNECTION, {
                  useNewUrlParser: true,
                  useUnifiedTopology: true,
                  serverSelectionTimeoutMS: 5000,
                  socketTimeoutMS: 45000,
                });
                console.log('MongoDB Connected Successfully');
                return conn;
              } catch (error) {
                console.error('Error Connecting to db', error);
                console.warn('âš ï¸ MongoDB connection failed. Some features may not work.');
                return null;
              }
            };
            
            module.exports = dbConnect;\`;
            
            fs.writeFileSync(dbFile, resilientDbCode);
            console.log('âœ“ Updated MongoDB connection');
          }
          FIXES_EOF
          
          node apply_fixes.js
          npm install
          
          # Create production .env file
          cat > .env.prod << 'EOF'
          FILE_UPLOAD_PATH=uploads/
          DUMP_PATH=dumps/
          PORT=8001
          AI_SERVER_URL=http://localhost:5000
          APIOPS_MODEL_URL=http://localhost:5000/apiops_model
          MONGO_CONNECTION=mongodb://localhost:27017/testdb?directConnection=true
          REDIRECT_URI=http://localhost:8001/auth/linkedin/callback
          CLIENT_ID=${{ secrets.LINKEDIN_CLIENT_ID }}
          CLIENT_SECRET=${{ secrets.LINKEDIN_CLIENT_SECRET }}
          STRIPE_LIVE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PAYMENT_WEBHOOK=${{ secrets.STRIPE_PAYMENT_WEBHOOK }}
          MAILGUN_DOMAIN=${{ secrets.MAILGUN_DOMAIN }}
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
          FREEPROJECTS_LIMIT=999
          MEMBERS_LIMIT=6
          PUBLISH_LIMIT=11
          SHAREDINBOX_EMAILID=${{ secrets.SHAREDINBOX_EMAILID }}
          SHAREDINBOX_PASSWORD=${{ secrets.SHAREDINBOX_PASSWORD }}
          O365_SMTP_SERVER=smtp.office365.com
          O365_SMTP_PORT=587
          GOOGLE_APPLICATION_CREDENTIALS=/tmp/ezapi/backend/creds.json
          EZAPI_BUCKET=${{ secrets.EZAPI_BUCKET }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          WORKOS_API_KEY=${{ secrets.WORKOS_API_KEY }}
          WORKOS_CLIENT_ID=${{ secrets.WORKOS_CLIENT_ID }}
          WORKOS_REDIRECT_URI=http://localhost:7744/auth/callback
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRE=30d
          NODE_ENV=production
          EOF
          
          zip -r ../node-backend.zip . -x "*.git*" "node_modules/*" "__pycache__/*" "*.log" "test*" "apply_fixes.js"

      # 6. Setup SSH for GCP
      - name: Setup SSH for GCP
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/gcp_key
          chmod 600 ~/.ssh/gcp_key
          ssh-keyscan -H "${{ secrets.GCP_VM_HOST }}" >> ~/.ssh/known_hosts

      # 7. Deploy to GCP VM
      - name: Deploy to GCP VM
        env:
          GCP_USER: ${{ secrets.GCP_VM_USER }}
          GCP_HOST: ${{ secrets.GCP_VM_HOST }}
        run: |
          ssh -i ~/.ssh/gcp_key $GCP_USER@$GCP_HOST "mkdir -p /tmp/ezapi/{ui,codegen,miner,backend,scripts,logs}"
          scp -i ~/.ssh/gcp_key ezapi-ui/dist/* $GCP_USER@$GCP_HOST:/tmp/ezapi/ui/
          scp -i ~/.ssh/gcp_key ezapi-codegen/target/*.jar $GCP_USER@$GCP_HOST:/tmp/ezapi/codegen/
          scp -i ~/.ssh/gcp_key python-app.zip $GCP_USER@$GCP_HOST:/tmp/ezapi/miner/
          scp -i ~/.ssh/gcp_key node-backend.zip $GCP_USER@$GCP_HOST:/tmp/ezapi/backend/

      # 8. Execute Deployment Script on GCP
      - name: Execute Deployment on GCP
        env:
          GCP_USER: ${{ secrets.GCP_VM_USER }}
          GCP_HOST: ${{ secrets.GCP_VM_HOST }}
        run: |
          cat > remote-deploy.sh << 'REMOTE_EOF'
          #!/bin/bash
          set -e
          
          echo "Starting deployment on GCP VM..."
          DEPLOY_BASE="/tmp/ezapi"
          
          # Extract all services
          cd $DEPLOY_BASE/miner && unzip -o python-app.zip
          cd $DEPLOY_BASE/backend && unzip -o node-backend.zip
          
          # Setup Python environment
          cd $DEPLOY_BASE/miner
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Setup Node.js
          cd $DEPLOY_BASE/backend
          npm install --production
          cp .env.prod .env
          
          # Ensure MongoDB is running
          sudo systemctl start mongodb || sudo systemctl start mongod || true
          
          # Install PM2 if not present
          if ! command -v pm2 &> /dev/null; then
            curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            sudo npm install -g pm2
          fi
          
          # Create PM2 ecosystem file
          cat > $DEPLOY_BASE/scripts/ecosystem.config.js << 'PM2_EOF'
          module.exports = {
            apps: [
              {
                name: 'java-codegen',
                cwd: '$DEPLOY_BASE/codegen',
                script: 'java',
                args: ['-jar', '*.jar', '--server.port=8002'],
                env: { NODE_ENV: 'production' }
              },
              {
                name: 'python-miner',
                cwd: '$DEPLOY_BASE/miner',
                script: '$DEPLOY_BASE/miner/venv/bin/python',
                args: ['app.py'],
                env: { 
                  NODE_ENV: 'production',
                  FLASK_DEBUG: '0',
                  PORT: '5000'
                }
              },
              {
                name: 'node-backend',
                cwd: '$DEPLOY_BASE/backend',
                script: 'npm',
                args: ['start'],
                env: { 
                  NODE_ENV: 'production',
                  PORT: '8001'
                }
              },
              {
                name: 'react-ui',
                cwd: '$DEPLOY_BASE/ui',
                script: 'python3',
                args: ['-m', 'http.server', '8004'],
                env: { NODE_ENV: 'production' }
              }
            ]
          }
          PM2_EOF
          
          # Start services with PM2
          pm2 delete all || true
          pm2 start $DEPLOY_BASE/scripts/ecosystem.config.js
          pm2 save
          sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u $USER --hp $HOME
          
          echo "Deployment completed successfully!"
          echo "Services status:"
          pm2 status
          REMOTE_EOF
          
          scp -i ~/.ssh/gcp_key remote-deploy.sh $GCP_USER@$GCP_HOST:/tmp/
          ssh -i ~/.ssh/gcp_key $GCP_USER@$GCP_HOST "chmod +x /tmp/remote-deploy.sh && /tmp/remote-deploy.sh"

      # 9. Final Verification
      - name: Verify Deployment
        env:
          GCP_USER: ${{ secrets.GCP_VM_USER }}
          GCP_HOST: ${{ secrets.GCP_VM_HOST }}
        run: |
          echo "ðŸŽ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "====================================="
          sleep 10
          echo "PM2 Status:"
          ssh -i ~/.ssh/gcp_key $GCP_USER@$GCP_HOST "pm2 status"
          echo ""
          echo "Application URLs:"
          echo "React UI:      http://$GCP_HOST:8004"
          echo "Node Backend:  http://$GCP_HOST:8001" 
          echo "Python Miner:  http://$GCP_HOST:5000"
          echo "Java Codegen:  http://$GCP_HOST:8002"
