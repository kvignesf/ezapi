name: EZAPI GCP Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/gcp_key
        chmod 600 ~/.ssh/gcp_key
        ssh-keyscan -H "${{ secrets.GCP_VM_HOST }}" >> ~/.ssh/known_hosts

    - name: Build React UI
      working-directory: ezapi-ui
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        REACT_APP_AES_ENCRYPTION_KEY: ${{ secrets.REACT_APP_AES_ENCRYPTION_KEY }}
        REACT_APP_LINKEDIN_CLIENT_ID: ${{ secrets.REACT_APP_LINKEDIN_CLIENT_ID }}
        REACT_APP_STRIPE_KEY: ${{ secrets.REACT_APP_STRIPE_KEY }}
      run: |
        npm install
        npm run build

    - name: Build Java Codegen
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: Package Java
      working-directory: ezapi-codegen
      run: mvn -B clean package -DskipTests

    - name: Package Python
      working-directory: ezapi-miner
      run: |
        pip install -r requirements.txt
        rm -f ../python-app.zip
        zip -r ../python-app.zip . -x "venv/*" "__pycache__/*" "*.log"

    - name: Package Node.js
      working-directory: ezapi-backend
      run: |
        npm install
        cat > .env.prod << EOF
        PORT=9001
        MONGO_CONNECTION=${{ secrets.MONGO_CONNECTION }}
        WORKOS_API_KEY=${{ secrets.WORKOS_API_KEY }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        STRIPE_LIVE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
        CLIENT_ID=${{ secrets.LINKEDIN_CLIENT_ID }}
        CLIENT_SECRET=${{ secrets.LINKEDIN_CLIENT_SECRET }}
        MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        NODE_ENV=production
        EOF
        rm -f ../node-backend.zip
        zip -r ../node-backend.zip . -x "node_modules/*" ".env*"

    - name: Deploy to GCP
      env:
        GCP_USER: ${{ secrets.GCP_VM_USER }}
        GCP_HOST: ${{ secrets.GCP_VM_HOST }}
      run: |
        ssh -i ~/.ssh/gcp_key $GCP_USER@$GCP_HOST "mkdir -p /tmp/ezapi/{ui,codegen,miner,backend,scripts,logs}"
        
        # Deploy files
        rsync -avz -e "ssh -i ~/.ssh/gcp_key" ezapi-ui/build/ $GCP_USER@$GCP_HOST:/tmp/ezapi/ui/
        rsync -avz -e "ssh -i ~/.ssh/gcp_key" ezapi-codegen/target/*.jar $GCP_USER@$GCP_HOST:/tmp/ezapi/codegen/
        rsync -avz -e "ssh -i ~/.ssh/gcp_key" python-app.zip $GCP_USER@$GCP_HOST:/tmp/ezapi/miner/
        rsync -avz -e "ssh -i ~/.ssh/gcp_key" node-backend.zip $GCP_USER@$GCP_HOST:/tmp/ezapi/backend/

        # Create and run deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        cd /tmp/ezapi
        
        # Extract packages
        cd miner && unzip -o python-app.zip && cd ..
        cd backend && unzip -o node-backend.zip && npm install --production && cp .env.prod .env && cd ..
        
        # Install PM2 if needed
        command -v pm2 >/dev/null || (curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs && sudo npm install -g pm2)
        
        # Stop existing services
        pm2 delete tmp-java tmp-python tmp-node tmp-react 2>/dev/null || true
        
        # Start services
        pm2 start --name tmp-react --cwd ui -- python3 -m http.server 9000
        pm2 start --name tmp-node --cwd backend -- npm start
        pm2 start --name tmp-java --cwd codegen -- java -jar *.jar --server.port=9002
        pm2 start --name tmp-python --cwd miner -- python3 app.py
        
        pm2 save
        echo "Deployment completed"
        EOF

        scp -i ~/.ssh/gcp_key deploy.sh $GCP_USER@$GCP_HOST:/tmp/ezapi/scripts/
        ssh -i ~/.ssh/gcp_key $GCP_USER@$GCP_HOST "chmod +x /tmp/ezapi/scripts/deploy.sh && /tmp/ezapi/scripts/deploy.sh"

    - name: Verify Deployment
      env:
        GCP_USER: ${{ secrets.GCP_VM_USER }}
        GCP_HOST: ${{ secrets.GCP_VM_HOST }}
      run: |
        echo "Services deployed to:"
        echo "React UI: http://$GCP_HOST:9000"
        echo "Node API: http://$GCP_HOST:9001" 
        echo "Java API: http://$GCP_HOST:9002"
        echo "Python API: http://$GCP_HOST:9003"
        ssh -i ~/.ssh/gcp_key $GCP_USER@$GCP_HOST "pm2 list"
