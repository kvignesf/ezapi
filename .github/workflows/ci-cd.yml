name: EZAPI Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Build React UI
      - name: Build React UI
        working-directory: ezapi-ui
        env:
          HUSKY: 0
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_AES_ENCRYPTION_KEY: ${{ secrets.REACT_APP_AES_ENCRYPTION_KEY }}
          REACT_APP_LINKEDIN_CLIENT_ID: ${{ secrets.REACT_APP_LINKEDIN_CLIENT_ID }}
          REACT_APP_STRIPE_KEY: ${{ secrets.REACT_APP_STRIPE_KEY }}
        run: |
          cat > .env << EOF
          REACT_APP_API_URL=$REACT_APP_API_URL
          REACT_APP_AES_ENCRYPTION_KEY=$REACT_APP_AES_ENCRYPTION_KEY
          REACT_APP_LINKEDIN_CLIENT_ID=$REACT_APP_LINKEDIN_CLIENT_ID
          REACT_APP_STRIPE_KEY=$REACT_APP_STRIPE_KEY
          EOF
          npm install
          npm run build
          mkdir -p build
          [ -f "index.html" ] && mv index.html build/ || true
          [ -d "static" ] && mv static build/ || true
          [ -f "manifest.json" ] && mv manifest.json build/ || true
          [ -f "conektto.ico" ] && mv conektto.ico build/ || true
          [ -f "msclarity.js" ] && mv msclarity.js build/ || true

      # 3. Setup Java JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 4. Build Java Codegen
      - name: Build Java Codegen
        working-directory: ezapi-codegen
        run: mvn -B clean package -DskipTests

      # 5. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 6. Install system dependencies
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc unixodbc-dev build-essential

      # 7. Build Python Miner
      - name: Build Python Miner
        working-directory: ezapi-miner
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install -r REQUIREMENTS.txt
          pip freeze > requirements_frozen.txt
          rm -f ../python-app.zip
          zip -r ../python-app.zip . -x "*.git*" "venv/*" "__pycache__/*"

      # 8. Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      # 9. Deploy to EC2
      - name: Deploy to EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_BASE: "/home/ubuntu/ezapi"
        run: |
          echo "Deploying to $EC2_USER@$EC2_HOST:$DEPLOY_BASE"
          
          ssh $EC2_USER@$EC2_HOST "echo 'SSH connection successful'"
          ssh $EC2_USER@$EC2_HOST "mkdir -p $DEPLOY_BASE/ui $DEPLOY_BASE/codegen $DEPLOY_BASE/miner $DEPLOY_BASE/scripts"
          
          rsync -avz ezapi-ui/build/ $EC2_USER@$EC2_HOST:$DEPLOY_BASE/ui/
          rsync -avz ezapi-codegen/target/*.jar $EC2_USER@$EC2_HOST:$DEPLOY_BASE/codegen/
          rsync -avz python-app.zip $EC2_USER@$EC2_HOST:$DEPLOY_BASE/miner/

      # 10. Deploy startup scripts
      - name: Deploy Startup Scripts
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_BASE: "/home/ubuntu/ezapi"
        run: |
          cat > start_services.sh << 'EOF'
          #!/bin/bash
          DEPLOY_BASE="/home/ubuntu/ezapi"
          
          sudo mkdir -p /var/app/ezapi_java_code_gen/logs/
          sudo chown ubuntu:ubuntu /var/app/ezapi_java_code_gen/logs/
          
          pkill -f "java -jar.*java_codgen_api" || true
          pkill -f "python3 app.py" || true
          pkill -f "python3 -m http.server" || true
          sleep 2
          
          cd $DEPLOY_BASE/codegen
          nohup java -jar java_codgen_api-0.0.1-SNAPSHOT.jar > java_app.log 2>&1 &
          echo $! > java_app.pid
          
          cd $DEPLOY_BASE/miner
          unzip -o python-app.zip > /dev/null 2>&1
          
          # Install Python build tools first
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv build-essential python3-dev
          
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          
          # Install dependencies with compatibility fixes
          pip install cachetools==5.0.0
          pip install certifi==2021.10.8
          pip install chardet==3.0.4
          pip install click==8.1.3
          pip install dnspython==2.0.0
          pip install Faker==4.5.0
          pip install Flask==2.1.2
          pip install Flask-Cors==3.0.8
          pip install google-api-core==2.7.3
          pip install google-auth==2.6.6
          pip install google-cloud-core==2.3.0
          pip install google-cloud-storage==2.1.0
          pip install google-crc32c==1.3.0
          pip install google-resumable-media==2.3.2
          pip install googleapis-common-protos==1.56.1
          pip install idna==2.10
          pip install importlib-metadata==4.11.3
          pip install itsdangerous==2.0.1
          pip install Jinja2==3.1.2
          pip install jsonref==0.2
          pip install MarkupSafe==2.1.1
          pip install numpy==1.22.3 --no-build-isolation
          pip install pandas==1.4.2 --no-build-isolation
          pip install protobuf==3.20.1
          pip install psycopg2-binary==2.9.3
          pip install pyasn1==0.4.8
          pip install pyasn1-modules==0.2.8
          pip install pycryptodome==3.14.1
          pip install pymongo==3.11.0
          pip install pyodbc==4.0.32 --no-build-isolation
          pip install python-dateutil==2.8.2
          pip install python-decouple==3.4
          pip install pytz==2022.1
          pip install requests==2.24.0
          pip install rsa==4.8
          pip install scipy==1.8.0 --no-build-isolation
          pip install shortuuid==1.0.9
          pip install six==1.16.0
          pip install sqlalchemy==2.0.7
          pip install text-unidecode==1.3
          pip install urllib3==1.25.11
          pip install wordninja==2.0.0
          pip install zipp==3.8.0
          pip install pyjwt==2.4.0
          pip install cx-oracle==8.3.0
          pip install oracledb==1.3.0
          
          nohup python3 app.py > python_app.log 2>&1 &
          echo $! > python_app.pid
          
          cd $DEPLOY_BASE/ui
          nohup python3 -m http.server 8000 > ui_server.log 2>&1 &
          echo $! > ui_server.pid
          EOF

          cat > check_services.sh << 'EOF'
          #!/bin/bash
          echo "EZAPI Services Status:"
          echo "======================"
          
          if ps aux | grep -q "[j]ava -jar.*java_codgen_api"; then
              echo "Java Codegen API:  RUNNING"
          else
              echo "Java Codegen API:  STOPPED"
          fi
          
          if ps aux | grep -q "[p]ython3 app.py"; then
              echo "Python Miner API:  RUNNING"
          else
              echo "Python Miner API:  STOPPED"
          fi
          
          if ps aux | grep -q "[p]ython3 -m http.server 8000"; then
              echo "React UI Server:  RUNNING"
          else
              echo "React UI Server:  STOPPED"
          fi
          
          echo "======================"
          echo "Access URLs:"
          echo "React UI:    http://$(curl -s ifconfig.me):8000"
          echo "Java API:    http://$(curl -s ifconfig.me):8080"
          echo "Python API:  http://$(curl -s ifconfig.me):5000"
          EOF

          cat > check_logs.sh << 'EOF'
          #!/bin/bash
          DEPLOY_BASE="/home/ubuntu/ezapi"
          echo "Recent Logs:"
          echo "Java Logs:"
          tail -10 $DEPLOY_BASE/codegen/java_app.log 2>/dev/null || echo "No Java logs found"
          echo ""
          echo "Python Logs:"
          tail -10 $DEPLOY_BASE/miner/python_app.log 2>/dev/null || echo "No Python logs found"
          echo ""
          echo "UI Logs:"
          tail -10 $DEPLOY_BASE/ui/ui_server.log 2>/dev/null || echo "No UI logs found"
          EOF

          cat > stop_services.sh << 'EOF'
          #!/bin/bash
          echo "Stopping EZAPI Services..."
          pkill -f "java -jar.*java_codgen_api" || true
          pkill -f "python3 app.py" || true
          pkill -f "python3 -m http.server 8000" || true
          echo "All services stopped"
          EOF

          ssh $EC2_USER@$EC2_HOST "mkdir -p $DEPLOY_BASE/scripts"
          scp start_services.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          scp check_services.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          scp check_logs.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          scp stop_services.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          
          ssh $EC2_USER@$EC2_HOST "chmod +x $DEPLOY_BASE/scripts/*.sh"
          ssh $EC2_USER@$EC2_HOST "ln -sf $DEPLOY_BASE/scripts/start_services.sh ~/start_ezapi.sh"
          ssh $EC2_USER@$EC2_HOST "ln -sf $DEPLOY_BASE/scripts/check_services.sh ~/check_ezapi.sh"
          ssh $EC2_USER@$EC2_HOST "ln -sf $DEPLOY_BASE/scripts/stop_services.sh ~/stop_ezapi.sh"

      # 11. Start services on EC2
      - name: Start Services on EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_BASE: "/home/ubuntu/ezapi"
        run: |
          ssh $EC2_USER@$EC2_HOST "cd $DEPLOY_BASE/scripts && ./start_services.sh"
          sleep 10
          ssh $EC2_USER@$EC2_HOST "cd $DEPLOY_BASE/scripts && ./check_services.sh"

      # 12. Final verification
      - name: Final Verification
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Deployment Complete"
          echo "=================="
          echo "All artifacts deployed"
          echo "Services started"
          echo "Access your application at:"
          echo "React UI:    http://$EC2_HOST:8000"
          echo "Java API:    http://$EC2_HOST:8080"
          echo "Python API:  http://$EC2_HOST:5000"
          echo ""
          echo "Management commands on EC2:"
          echo "~/start_ezapi.sh    - Start all services"
          echo "~/check_ezapi.sh    - Check service status"
          echo "~/stop_ezapi.sh     - Stop all services"
