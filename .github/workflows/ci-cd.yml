name: EZAPI Build, Deploy & Start Services

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repo
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Build React UI
      - name: Build React UI
        working-directory: ezapi-ui
        env:
          HUSKY: 0
        run: |
          echo "Building React UI with Webpack..."
          cat > .env << EOF
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL || '' }}
          REACT_APP_AES_ENCRYPTION_KEY=${{ secrets.REACT_APP_AES_ENCRYPTION_KEY || '' }}
          REACT_APP_LINKEDIN_CLIENT_ID=${{ secrets.REACT_APP_LINKEDIN_CLIENT_ID || '' }}
          REACT_APP_STRIPE_KEY=${{ secrets.REACT_APP_STRIPE_KEY || '' }}
          EOF
          npm install
          npm run build
          mkdir -p build
          # Move webpack output to build directory
          [ -f "index.html" ] && mv index.html build/ || true
          [ -d "static" ] && mv static build/ || true
          [ -f "manifest.json" ] && mv manifest.json build/ || true
          [ -f "conektto.ico" ] && mv conektto.ico build/ || true
          [ -f "msclarity.js" ] && mv msclarity.js build/ || true

      # 3. Setup Java JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 4. Build Java Codegen
      - name: Build Java Codegen
        working-directory: ezapi-codegen
        run: mvn -B clean package -DskipTests

      # 5. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 6. Install system dependencies
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc unixodbc-dev build-essential

      # 7. Build Python Miner
      - name: Build Python Miner
        working-directory: ezapi-miner
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install -r REQUIREMENTS.txt
          rm -f ../python-app.zip
          zip -r ../python-app.zip . -x "*.git*" "venv/*" "__pycache__/*"

      # 8. Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      # 9. Deploy to EC2
      - name: Deploy to EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_BASE: "/home/ubuntu/ezapi"
        run: |
          echo "ðŸš€ Deploying to $EC2_USER@$EC2_HOST:$DEPLOY_BASE"
          
          # Test connection
          ssh $EC2_USER@$EC2_HOST "echo 'âœ… SSH connection successful'"
          
          # Create deployment directories
          ssh $EC2_USER@$EC2_HOST "mkdir -p $DEPLOY_BASE/ui $DEPLOY_BASE/codegen $DEPLOY_BASE/miner $DEPLOY_BASE/scripts"
          
          # Deploy files
          echo "ðŸ“¦ Deploying React UI..."
          rsync -avz ezapi-ui/build/ $EC2_USER@$EC2_HOST:$DEPLOY_BASE/ui/
          
          echo "ðŸ“¦ Deploying Java Codegen..."
          rsync -avz ezapi-codegen/target/*.jar $EC2_USER@$EC2_HOST:$DEPLOY_BASE/codegen/
          
          echo "ðŸ“¦ Deploying Python Miner..."
          rsync -avz python-app.zip $EC2_USER@$EC2_HOST:$DEPLOY_BASE/miner/

      # 10. Create and Deploy Startup Scripts
      - name: Deploy Startup Scripts
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_BASE: "/home/ubuntu/ezapi"
        run: |
          echo "ðŸ“œ Deploying startup scripts..."
          
          # Create main startup script
          cat > start_services.sh << 'EOF'
          #!/bin/bash
          echo "ðŸš€ Starting EZAPI Services..."
          DEPLOY_BASE="/home/ubuntu/ezapi"
          
          # 1. Create Java log directory
          sudo mkdir -p /var/app/ezapi_java_code_gen/logs/
          sudo chown ubuntu:ubuntu /var/app/ezapi_java_code_gen/logs/
          
          # 2. Stop any running services
          echo "ðŸ›‘ Stopping any existing services..."
          pkill -f "java -jar.*java_codgen_api" || true
          pkill -f "python3 app.py" || true
          pkill -f "python3 -m http.server" || true
          sleep 2
          
          # 3. Start Java Codegen API
          echo "â˜• Starting Java Codegen API..."
          cd $DEPLOY_BASE/codegen
          nohup java -jar java_codgen_api-0.0.1-SNAPSHOT.jar > java_app.log 2>&1 &
          JAVA_PID=$!
          echo $JAVA_PID > java_app.pid
          
          # 4. Start Python Miner API
          echo "ðŸ Starting Python Miner API..."
          cd $DEPLOY_BASE/miner
          unzip -o python-app.zip > /dev/null 2>&1
          nohup python3 app.py > python_app.log 2>&1 &
          PYTHON_PID=$!
          echo $PYTHON_PID > python_app.pid
          
          # 5. Start React UI
          echo "âš›ï¸  Starting React UI..."
          cd $DEPLOY_BASE/ui
          nohup python3 -m http.server 8000 > ui_server.log 2>&1 &
          UI_PID=$!
          echo $UI_PID > ui_server.pid
          
          echo "âœ… Services started!"
          echo "ðŸ“Š Check status with: ./scripts/check_services.sh"
          echo "ðŸ“‹ Check logs with: ./scripts/check_logs.sh"
          EOF
          
          # Create service check script
          cat > check_services.sh << 'EOF'
          #!/bin/bash
          echo "ðŸ” EZAPI Services Status:"
          echo "=========================="
          
          # Check Java
          if ps aux | grep -q "[j]ava -jar.*java_codgen_api"; then
              echo "â˜• Java Codegen API:  âœ… RUNNING"
          else
              echo "â˜• Java Codegen API:  âŒ STOPPED"
          fi
          
          # Check Python
          if ps aux | grep -q "[p]ython3 app.py"; then
              echo "ðŸ Python Miner API:  âœ… RUNNING"
          else
              echo "ðŸ Python Miner API:  âŒ STOPPED"
          fi
          
          # Check UI
          if ps aux | grep -q "[p]ython3 -m http.server 8000"; then
              echo "âš›ï¸  React UI Server:  âœ… RUNNING"
          else
              echo "âš›ï¸  React UI Server:  âŒ STOPPED"
          fi
          
          echo "=========================="
          echo "ðŸŒ Access URLs:"
          echo "React UI:    http://$(curl -s ifconfig.me):8000"
          echo "Java API:    http://$(curl -s ifconfig.me):8080"
          echo "Python API:  http://$(curl -s ifconfig.me):5000"
          EOF
          
          # Create log check script
          cat > check_logs.sh << 'EOF'
          #!/bin/bash
          DEPLOY_BASE="/home/ubuntu/ezapi"
          echo "ðŸ“‹ Recent Logs:"
          echo "Java Logs:"
          tail -10 $DEPLOY_BASE/codegen/java_app.log 2>/dev/null || echo "No Java logs found"
          echo ""
          echo "Python Logs:"
          tail -10 $DEPLOY_BASE/miner/python_app.log 2>/dev/null || echo "No Python logs found"
          echo ""
          echo "UI Logs:"
          tail -10 $DEPLOY_BASE/ui/ui_server.log 2>/dev/null || echo "No UI logs found"
          EOF
          
          # Create stop script
          cat > stop_services.sh << 'EOF'
          #!/bin/bash
          echo "ðŸ›‘ Stopping EZAPI Services..."
          pkill -f "java -jar.*java_codgen_api" || true
          pkill -f "python3 app.py" || true
          pkill -f "python3 -m http.server 8000" || true
          echo "âœ… All services stopped"
          EOF
          
          # Deploy scripts to EC2
          ssh $EC2_USER@$EC2_HOST "mkdir -p $DEPLOY_BASE/scripts"
          scp start_services.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          scp check_services.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          scp check_logs.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          scp stop_services.sh $EC2_USER@$EC2_HOST:$DEPLOY_BASE/scripts/
          
          # Make scripts executable
          ssh $EC2_USER@$EC2_HOST "chmod +x $DEPLOY_BASE/scripts/*.sh"
          
          # Create symlinks in home directory for easy access
          ssh $EC2_USER@$EC2_HOST "ln -sf $DEPLOY_BASE/scripts/start_services.sh ~/start_ezapi.sh"
          ssh $EC2_USER@$EC2_HOST "ln -sf $DEPLOY_BASE/scripts/check_services.sh ~/check_ezapi.sh"
          ssh $EC2_USER@$EC2_HOST "ln -sf $DEPLOY_BASE/scripts/stop_services.sh ~/stop_ezapi.sh"

      # 11. Start Services on EC2
      - name: Start Services on EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DEPLOY_BASE: "/home/ubuntu/ezapi"
        run: |
          echo "ðŸŽ¯ Starting services on EC2..."
          ssh $EC2_USER@$EC2_HOST "cd $DEPLOY_BASE/scripts && ./start_services.sh"
          
          # Wait a bit for services to start
          sleep 10
          
          # Check service status
          echo "ðŸ” Checking service status..."
          ssh $EC2_USER@$EC2_HOST "cd $DEPLOY_BASE/scripts && ./check_services.sh"

      # 12. Final Verification
      - name: Final Verification
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "ðŸŽ‰ Deployment Complete!"
          echo "======================"
          echo "âœ… All artifacts deployed"
          echo "âœ… Services started"
          echo "ðŸŒ Access your application at:"
          echo "   React UI:    http://$EC2_HOST:8000"
          echo "   Java API:    http://$EC2_HOST:8080" 
          echo "   Python API:  http://$EC2_HOST:5000"
          echo ""
          echo "ðŸ”§ Management commands on EC2:"
          echo "   ~/start_ezapi.sh    - Start all services"
          echo "   ~/check_ezapi.sh    - Check service status"
          echo "   ~/stop_ezapi.sh     - Stop all services"
