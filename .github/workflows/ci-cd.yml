name: Monorepo CI/CD â€” build & deploy all apps

on:
  push:
    branches:
      - main
      - dev
      - stage

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  DEPLOY_BASE: /home/${{ secrets.EC2_USER }}/apps

jobs:
  build_python:
    name: Build Python (ezapi-miner)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Build / Install deps (venv + requirements)
        working-directory: repo/ezapi-miner
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Archive Python app
        working-directory: repo/ezapi-miner
        run: |
          rm -f ../../python-app.zip
          zip -r ../../python-app.zip . -x "*.git*" "venv/*" "__pycache__/*"

      - name: Upload python artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: repo/python-app.zip

  build_java:
    name: Build Java (ezapi-codegen)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Build with Maven
        working-directory: repo/ezapi-codegen
        run: mvn -B clean package -DskipTests

      - name: Upload jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: java-artifact
          path: repo/ezapi-codegen/target/*.jar

  build_react:
    name: Build React (ezapi-ui)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo

      - name: Create .env file
        working-directory: repo/ezapi-ui
        run: |
          echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > .env
          echo "REACT_APP_AES_ENCRYPTION_KEY=${{ secrets.REACT_APP_AES_ENCRYPTION_KEY }}" >> .env
          echo "REACT_APP_LINKEDIN_CLIENT_ID=${{ secrets.REACT_APP_LINKEDIN_CLIENT_ID }}" >> .env
          echo "REACT_APP_STRIPE_KEY=${{ secrets.REACT_APP_STRIPE_KEY }}" >> .env

      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies & build
        working-directory: repo/ezapi-ui
        run: |
          npm install
          npm run build

      - name: Upload web-build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: repo/ezapi-ui/dist/

  deploy_all:
    name: Deploy all to EC2
    runs-on: ubuntu-latest
    needs: [build_python, build_java, build_react]
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo

      # Download artifacts
      - name: Download python artifact
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: artifacts/python

      - name: Download java artifact
        uses: actions/download-artifact@v4
        with:
          name: java-artifact
          path: artifacts/java

      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: artifacts/web

      # Setup SSH
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      # Create deploy dirs on EC2
      - name: Create target directories on EC2
        run: |
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "mkdir -p ${DEPLOY_BASE}/ezapi-miner ${DEPLOY_BASE}/ezapi-codegen /home/${{ env.EC2_USER }}/static_build"

      # Deploy Python
      - name: Copy Python zip & deploy script
        run: |
          scp artifacts/python/python-app.zip ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${DEPLOY_BASE}/ezapi-miner/
          scp repo/deploy-scripts/deploy_python.sh ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${DEPLOY_BASE}/ezapi-miner/
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "cd ${DEPLOY_BASE}/ezapi-miner && unzip -o python-app.zip && chmod +x deploy_python.sh && bash deploy_python.sh"

      # Deploy Java
      - name: Copy Java jar & deploy script
        run: |
          scp artifacts/java/*.jar ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${DEPLOY_BASE}/ezapi-codegen/
          scp repo/deploy-scripts/deploy_java.sh ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${DEPLOY_BASE}/ezapi-codegen/
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "cd ${DEPLOY_BASE}/ezapi-codegen && chmod +x deploy_java.sh && bash deploy_java.sh"

      # Deploy React
      - name: Copy React build & deploy script
        run: |
          scp -r artifacts/web/* ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:/home/${{ env.EC2_USER }}/static_build/
          scp repo/deploy-scripts/deploy_react.sh ${{ env.EC2_USER }}@${{ env.EC2_HOST }}/
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "chmod +x deploy_react.sh && ./deploy_react.sh"

      - name: Confirm services are running
        run: |
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "systemctl status ezapi-miner.service --no-pager || true"
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "systemctl status ezapi-codegen.service --no-pager || true"
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "curl -f http://127.0.0.1 || true"

