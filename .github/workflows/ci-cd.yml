name: Monorepo CI/CD â€” build & deploy all apps

on:
  push:
    branches:
      - main
      - dev
      - stage

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  DEPLOY_BASE: /home/${{ secrets.EC2_USER }}/apps

jobs:
  build_python:
    name: Build Python (ezapi-miner)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Build / Install deps (venv + wheel)
        working-directory: repo/ezapi-miner
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          if [ -f REQUIREMENTS.txt ]; then pip install -r REQUIREMENTS.txt; fi
      - name: Archive Python app
        working-directory: repo/ezapi-miner
        run: |
          rm -f ../../../python-app.zip
          zip -r ../../../python-app.zip . -x "*.git*" "venv/*" "__pycache__/*"

      - name: Upload python artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: python-app.zip

  build_java:
    name: Build Java (ezapi-codegen)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Build with Maven
        working-directory: repo/ezapi-codegen
        run: mvn -B clean package -DskipTests
      - name: Upload jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: java-artifact
          path: repo/ezapi-codegen/target/*.jar

  build_react:
    name: Build React (ezapi-ui)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies & build
        working-directory: repo/ezapi-ui
        run: |
          npm ci
          npm run build
      - name: Upload web-build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: repo/ezapi-ui/dist/

  deploy_all:
    name: Deploy all to EC2
    runs-on: ubuntu-latest
    needs: [build_python, build_java, build_react]
    steps:
      - uses: actions/checkout@v5
        with:
          path: repo

      # get artifacts
      - name: Download python artifact
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: artifacts/python

      - name: Download java artifact
        uses: actions/download-artifact@v4
        with:
          name: java-artifact
          path: artifacts/java

      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: artifacts/web

      # setup ssh
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      # Create deploy dirs on EC2
      - name: Create target directories on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ${DEPLOY_BASE}/ezapi-miner ${DEPLOY_BASE}/ezapi-codegen /home/${{ secrets.EC2_USER }}/static_build"

      # Copy python zip & scripts, unzip & run deploy
      - name: Copy Python zip & deploy script
        run: |
          scp -o StrictHostKeyChecking=no artifacts/python/python-app.zip ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${DEPLOY_BASE}/ezapi-miner/
          scp -o StrictHostKeyChecking=no deploy-scripts/deploy_python.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${DEPLOY_BASE}/ezapi-miner/
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cd ${DEPLOY_BASE}/ezapi-miner && unzip -o python-app.zip -d . && chmod +x deploy_python.sh && bash deploy_python.sh"

      # Copy jar & run deploy
      - name: Copy Java jar & deploy script
        run: |
          scp -o StrictHostKeyChecking=no artifacts/java/*.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${DEPLOY_BASE}/ezapi-codegen/
          scp -o StrictHostKeyChecking=no deploy-scripts/deploy_java.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${DEPLOY_BASE}/ezapi-codegen/
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cd ${DEPLOY_BASE}/ezapi-codegen && chmod +x deploy_java.sh && bash deploy_java.sh"

      # Copy react build to /home/ubuntu/static_build and run deploy script to move into nginx dir
      - name: Copy React build & deploy script
        run: |
          scp -r -o StrictHostKeyChecking=no artifacts/web/* ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/static_build/
          scp -o StrictHostKeyChecking=no deploy-scripts/deploy_react.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "chmod +x /home/${{ secrets.EC2_USER }}/deploy_react.sh && /home/${{ secrets.EC2_USER }}/deploy_react.sh"

      - name: Confirm services are running
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "systemctl status ezapi-miner.service --no-pager || true; systemctl status ezapi-codegen.service --no-pager || true; curl -f http://127.0.0.1 || true"

